<tool id="flowAI" name="flowAI" version="1.0">
  <description> detects anomalies from Flow Rate, Signal Acquisition and Dynamic Range</description>
  <command>
      Rscript --slave --vanilla $GALAXY_ROOT_DIR/tools/flowtools/FCSflowAI.R --args $input $remove $alphaFR $chremFS $outFS $penFS $sideFM $full_rep $highfcs $lowfcs $qcfcs
  </command>
  <inputs>
    <param format="fcs" name="input" type="data" label="FCS file"/>
    <param name="remove" type="select" label="Remove low quality cells from:">
          <option value="all">Flow rate, Signal acquisition and Dynamic range</option>
          <option value="FR_FS">Flow rate and Signal acquisition</option>
          <option value="FR_FM">Flow rate and Dynamic range</option>
          <option value="FS_FM">Signal acquisition and Dynamic range</option>
          <option value="FR">Flow rate</option>
          <option value="FS">Signal acquisition</option>
          <option value="FM">Dynamic range</option>
    </param>   
    <param name="alphaFR" type="float" label="Significance threshold for flow rate check" value="0.01"/>
    <param name="chremFS" type="boolean" checked="true" truevalue="TRUE" falsevalue="FALSE" label="Do you want to exclude the FSC and SSC parameters from the signal acquisition check?"/>
    <param name="outFS" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="Do you want to remove outliers before the signal acquisition check?"/>
    <param name="penFS" type="integer" label="Stringency of signal acquisition check (higher tolerance with higher values)" value="200"/>
    <param name="sideFM" type="select" label="Include in dynamic range check:">
      <option value="both">Both limits</option>
      <option value="upper">Upper limit only</option>
      <option value="lower">Lower limit only</option>
    </param>
    <param name="highQ_FCS" type="boolean" checked="true" truevalue="TRUE" falsevalue="FALSE" label="Create FCS file with only high quality events?"/>    
    <param name="lowQ_FCS" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="Create FCS file with only low quality events?"/>
    <param name="QC_FCS" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="Create FCS file with an additional parameter where low quality events have values higher than 10,000?"/>
  </inputs>

  <outputs>
    <data format="html" name="full_rep" label="QC of ${input.name}">
    </data>
    <data format="fcs" name="highfcs" label="High quality events from ${input.name}">
      <filter>(highQ_FCS)</filter>
    </data>
    <data format="fcs" name="lowfcs" label="Low quality events from ${input.name}">
      <filter>(lowQ_FCS)</filter>
    </data>
    <data format="fcs" name="qcfcs" label="All events (low quality event marked up) from ${input.name}">
      <filter>(QC_FCS)</filter>
    </data>
  </outputs>
  <stdio>
    <exit_code range="2:" level="fatal" description="See stderr for more details." />
  </stdio>

<help>
This tool automatically performs quality control of flow cytometry data by checking three fundamental properties:

* **Flow rate**
* **Signal acquisition**
* **Dynamic range**

-----

.. class:: infomark

The algorithm produces informative plots that are embedded in a html report. The evaluation of the report is fundamental to::

  1. Eventually adjust the quality control parameters  
  2. Discard totally abnormal FCS files  
  3. Verify if there are recurrent issues  

Find more information about our method in the article or the bioconductor vignette about the flowAI R package.
 </help>
<citations>
  <citation type="doi">10.1093/bioinformatics/btw191</citation>
</citations>
</tool>
