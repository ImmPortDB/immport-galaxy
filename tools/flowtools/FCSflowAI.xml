<tool id="flowAI" name="flowAI" version="1.0">
  <description> automatic quality control </description>
  <requirements>
    <requirement type="package" version="3.3.0">r</requirement>
    <requirement type="package" version="1.38.2">bioconductor-flowcore</requirement>
    <requirement type="package" version="1.2.8">bioconductor-flowai</requirement>
  </requirements>
  <stdio>
    <exit_code range="2:" level="fatal" description="See stderr for more details." />
  </stdio>
  <command><![CDATA[
      Rscript --slave --vanilla $GALAXY_ROOT_DIR/tools/flowtools/FCSflowAI.R --args "${input}" "${remove}" $alphaFR $chremFS $outFS $penFS "${sideFM}" "${full_rep}" $highfcs $lowfcs $qcfcs
  ]]>
  </command>
  <inputs>
    <param format="fcs" name="input" type="data" label="FCS file"/>
    <param name="remove" type="select" label="Remove low quality cells from:">
          <option value="all">Flow rate, Signal acquisition and Dynamic range</option>
          <option value="FR_FS">Flow rate and Signal acquisition</option>
          <option value="FR_FM">Flow rate and Dynamic range</option>
          <option value="FS_FM">Signal acquisition and Dynamic range</option>
          <option value="FR">Flow rate</option>
          <option value="FS">Signal acquisition</option>
          <option value="FM">Dynamic range</option>
    </param>   
    <param name="alphaFR" type="float" label="Significance threshold for flow rate check:" value="0.01"/>
    <param name="chremFS" type="boolean" checked="true" truevalue="TRUE" falsevalue="FALSE" label="Do you want to exclude the FSC and SSC parameters from the signal acquisition check?"/>
    <param name="outFS" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="Do you want to remove outliers before the signal acquisition check?"/>
    <param name="penFS" type="integer" label="Stringency of signal acquisition check (higher tolerance with higher values):" value="200"/>
    <param name="sideFM" type="select" label="Include in dynamic range check:">
      <option value="both">Both limits</option>
      <option value="upper">Upper limit only</option>
      <option value="lower">Lower limit only</option>
    </param>
    <param name="highQ_FCS" type="boolean" checked="true" truevalue="TRUE" falsevalue="FALSE" label="Create FCS file with only high quality events?"/>    
    <param name="lowQ_FCS" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="Create FCS file with only low quality events?"/>
    <param name="QC_FCS" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="Create FCS file with an additional parameter where low quality events have values higher than 10,000?"/>
  </inputs>
  <outputs>
    <data format="html" name="full_rep" label="QC of ${input.name}">
    </data>
    <data format="fcs" name="highfcs" label="High quality events only from ${input.name}">
      <filter>(highQ_FCS)</filter>
    </data>
    <data format="fcs" name="lowfcs" label="Low quality events only from ${input.name}">
      <filter>(lowQ_FCS)</filter>
    </data>
    <data format="fcs" name="qcfcs" label="All events (low quality event marked up) from ${input.name}">
      <filter>(QC_FCS)</filter>
    </data>
  </outputs>
  <tests>
    <test>
      <param name="input" value="input.fcs"/>
      <param name="remove" value="all"/>
      <param name="alphaFR" value="0.01"/>
      <param name="chremFS" value="TRUE"/>
      <param name="outFS" value="FALSE"/>
      <param name="penFS" value="200"/>
      <param name="sideFM" value="both"/>
      <param name="highQ_FCS" value="TRUE"/>
      <param name="lowQ_FCS" value="TRUE"/>
      <param name="QC_FCS" value="TRUE"/>
      <output name="full_rep" file="QCreport.html"/>
      <output name="highfcs" file="hqdata.fcs"/>
      <output name="lowfcs" file="lqdata.fcs"/>
      <output name="qcfcs" file="alldata.fcs"/>
    </test>
    <test>
      <param name="input" value="input.fcs"/>
      <param name="remove" value="all"/>
      <param name="alphaFR" value="0.01"/>
      <param name="chremFS" value="TRUE"/>
      <param name="outFS" value="FALSE"/>
      <param name="penFS" value="200"/>
      <param name="sideFM" value="both"/>
      <param name="highQ_FCS" value="TRUE"/>
      <param name="lowQ_FCS" value="FALSE"/>
      <param name="QC_FCS" value="FALSE"/>
      <output name="full_rep" file="std/QCreport.html"/>
      <output name="highfcs" file="std/hqdata.fcs"/>
    </test>
    <test>
      <param name="input" value="input.fcs"/>
      <param name="remove" value="all"/>
      <param name="alphaFR" value="0.01"/>
      <param name="chremFS" value="TRUE"/>
      <param name="outFS" value="FALSE"/>
      <param name="penFS" value="200"/>
      <param name="sideFM" value="both"/>
      <param name="highQ_FCS" value="TRUE"/>
      <param name="lowQ_FCS" value="TRUE"/>
      <param name="QC_FCS" value="TRUE"/>
      <output name="full_rep" file="std/QCreport.html"/>
      <output name="highfcs" file="std/hqdata.fcs"/>
      <output name="lowfcs" file="std/lqdata.fcs"/>
      <output name="qcfcs" file="std/alldata.fcs"/>
    </test>
    <test>
      <param name="input" value="input.fcs"/>
      <param name="remove" value="all"/>
      <param name="alphaFR" value="0.01"/>
      <param name="chremFS" value="TRUE"/>
      <param name="outFS" value="TRUE"/>
      <param name="penFS" value="200"/>
      <param name="sideFM" value="both"/>
      <param name="highQ_FCS" value="TRUE"/>
      <param name="lowQ_FCS" value="TRUE"/>
      <param name="QC_FCS" value="TRUE"/>
      <output name="full_rep" file="nooutliers/QCreport_nooutliers.html"/>
      <output name="highfcs" file="nooutliers/hqdata_nooutliers.fcs"/>
    </test>
    <test>
      <param name="input" value="input.fcs"/>
      <param name="remove" value="all"/>
      <param name="alphaFR" value="0.01"/>
      <param name="chremFS" value="FALSE"/>
      <param name="outFS" value="FALSE"/>
      <param name="penFS" value="200"/>
      <param name="sideFM" value="both"/>
      <param name="highQ_FCS" value="TRUE"/>
      <param name="lowQ_FCS" value="TRUE"/>
      <param name="QC_FCS" value="TRUE"/>
      <output name="full_rep" file="withsfsc/QCreport_sfsc.html"/>
      <output name="highfcs" file="withsfsc/hqdata_sfsc.fcs"/>
    </test>
  </tests>
  <help><![CDATA[
   This tool automatically performs quality control of flow cytometry data.

-----

**Input files**

The output files required are::

  • One or more FCS files. 

**Output files**

The output files generated are::

  • full HTML report,
  • new FCS file containing only the high quality events (default),
  • new FCS file containing only the low quality events (optional),
  • original FCS file containing an additional parameter where the low quality events have a value higher than 10,000 (optional).


The files generated will be FCS 3.0.

----

Description of the approach
'''''''''''''''''''''''''''
The approach of the tool is to separately check and discern anomalies from three fundamental properties of flow cytometry data:

  - *Flow rate*. Surges and substantial shifts of the rate of the cells passing through the capillary tube are detected.

  - *Signal acquisition*. Instability in the signal acquired for each channel are detected. In most cases it corresponds to flow rate surges and shifts.

  - *Dynamic range*. Values recorded in the upper limit (margin events) and negative outliers are removed.
   
.. class:: infomark

At the end of the analysis, a HTML report is generated with embedded informative plots. The evaluation of the report is not only fundamental to check the status of the FCS file but also to::

  1. Eventually adjust the quality control parameters  
  2. Discard the entire FCS file because of an unacceptable number of anomalies
  3. Program a flow cytometry maintenance because of recurrent issues


Parameters
''''''''''
The default settings should work well for the majority of cases. Nonetheless it might be necessary to customize the setting according to the dataset used. 
For example, for FCS files of large dimension it is usually better to use more tolerant setting (higher values) for the signal acquisition check.


Example
'''''''
This section reports an example of the quality control with flowAI and the plots generated for the HTML report:


Flow rate check. the anomalies are flagged with a green circle. The quality control detected and discarded a surge and a shift from the median value in the last part of the experiment.

.. image:: ../../static/images/flowtools/autoflowrate.png

Signal acquisition check. The stable region has a yellow background. The algorithm detects shifts in signal acquisitions for each channel separately and then it retains the biggest common region with no anomalies.

.. image:: ../../static/images/flowtools/autosignal.png

Dynamic range check. The red and blue line indicates the number of events detected over time. The x-axis corresponds to the one of the signal acquisition plot.

.. image:: ../../static/images/flowtools/margins.png

 ]]>
 </help>
<citations>
  <citation type="doi">10.1093/bioinformatics/btw191</citation>
</citations>
</tool>
