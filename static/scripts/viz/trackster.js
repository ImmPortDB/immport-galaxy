define("viz/trackster",["exports","utils/localization","libs/underscore","libs/backbone","viz/trackster/tracks","viz/visualization","mvc/ui/icon-button","utils/query-string-parsing","mvc/grid/grid-view","utils/utils","libs/jquery/jquery.event.drag","libs/jquery/jquery.event.hover","libs/jquery/jquery.mousewheel","libs/jquery/jquery-ui","libs/jquery/select2","libs/farbtastic","libs/jquery/jquery.form","libs/jquery/jquery.rating","ui/editable-text"],function(e,t,i,a,o,n,r,s,l,u){"use strict";function d(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}function c(e){return e&&e.__esModule?e:{default:e}}function v(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function w(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(e,"__esModule",{value:!0});var h=c(t),_=d(i),p=d(a),y=c(o),b=c(n),k=c(r),g=c(s),m=c(l),x=c(u),j=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),z=function(e){function t(e){return v(this,t),w(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return f(t,p.Model),j(t,[{key:"initialize",value:function(e){this.baseURL=e,x.default.cssLoadFile("static/style/jquery.rating.css"),x.default.cssLoadFile("static/style/autocomplete_tagging.css"),x.default.cssLoadFile("static/style/jquery-ui/smoothness/jquery-ui.css"),x.default.cssLoadFile("static/style/library.css"),x.default.cssLoadFile("static/style/trackster.css")}},{key:"save_viz",value:function(){var e=this;Galaxy.modal.show({title:"Saving...",body:"progress"});var t=[];$(".bookmark").each(function(){t.push({position:$(e).children(".position").text(),annotation:$(e).children(".annotation").text()})});var i=this.view.overview_drawable?this.view.overview_drawable.config.get_value("name"):null,a={view:this.view.to_dict(),viewport:{chrom:this.view.chrom,start:this.view.low,end:this.view.high,overview:i},bookmarks:t};return $.ajax({url:Galaxy.root+"visualization/save",type:"POST",dataType:"json",data:{id:this.view.vis_id,title:this.view.config.get_value("name"),dbkey:this.view.dbkey,type:"trackster",vis_json:JSON.stringify(a)}}).success(function(t){Galaxy.modal.hide(),e.view.vis_id=t.vis_id,e.view.has_changes=!1,window.history.pushState({},"",t.url+window.top.location.hash)}).error(function(){Galaxy.modal.show({title:(0,h.default)("Could Not Save"),body:"Could not save visualization. Please try again later.",buttons:{Cancel:function(){Galaxy.modal.hide()}}})})}},{key:"createButtonMenu",value:function(){var e=this,t=k.default.create_icon_buttons_menu([{icon_class:"plus-button",title:(0,h.default)("Add tracks"),on_click:function(){b.default.select_datasets({dbkey:e.view.dbkey},function(t){_.each(t,function(t){e.view.add_drawable(y.default.object_from_template(t,e.view,e.view))})})}},{icon_class:"block--plus",title:(0,h.default)("Add group"),on_click:function(){e.view.add_drawable(new y.default.DrawableGroup(e.view,e.view,{name:"New Group"}))}},{icon_class:"bookmarks",title:(0,h.default)("Bookmarks"),on_click:function(){window.force_right_panel("0px"==$("div#right").css("right")?"hide":"show")}},{icon_class:"globe",title:(0,h.default)("Circster"),on_click:function(){window.top.location=e.baseURL+"visualization/circster?id="+e.view.vis_id}},{icon_class:"disk--arrow",title:(0,h.default)("Save"),on_click:function(){e.save_viz()}},{icon_class:"cross-circle",title:(0,h.default)("Close"),on_click:function(){e.handle_unsaved_changes(e.view)}}],{tooltip_config:{placement:"bottom"}});return this.buttonMenu=t,t}},{key:"add_bookmark",value:function(e,t,i){var a=this,o=$("#right .unified-panel-body"),n=$("<div/>").addClass("bookmark").appendTo(o),r=$("<div/>").addClass("position").appendTo(n);$("<a href=''/>").text(e).appendTo(r).click(function(){return a.view.go_to(e),!1});var s=$("<div/>").text(t).appendTo(n);if(i){var l=$("<div/>").addClass("delete-icon-container").prependTo(n).click(function(){return n.slideUp("fast"),n.remove(),a.view.has_changes=!0,!1});$("<a href=''/>").addClass("icon-button delete").appendTo(l),s.make_text_editable({num_rows:3,use_textarea:!0,help_text:"Edit bookmark note"}).addClass("annotation")}return this.view.has_changes=!0,n}},{key:"create_visualization",value:function(e,t,i,a,o){var n=this;return this.view=new y.default.TracksterView(_.extend(e,{header:!1})),this.view.editor=!0,$.when(this.view.load_chroms_deferred).then(function(e){var r=null;if(t){var s=t.chrom,l=t.start,u=t.end;r=t.overview,s&&void 0!==l&&u?n.view.change_chrom(s,l,u):n.view.change_chrom(e[0].chrom)}else n.view.change_chrom(e[0].chrom);if(i)for(var d=0;d<i.length;d++)n.view.add_drawable(y.default.object_from_template(i[d],n.view,n.view));for(var c=0;c<n.view.drawables.length;c++)if(n.view.drawables[c].config.get_value("name")===r){n.view.set_overview(n.view.drawables[c]);break}if(a)for(var v,w=0;w<a.length;w++)v=a[w],n.add_bookmark(v.position,v.annotation,o);n.view.has_changes=!1}),this.set_up_router({view:this.view}),this.view}},{key:"set_up_router",value:function(e){new b.default.TrackBrowserRouter(e),p.history.start()}},{key:"init_keyboard_nav",value:function(e){$(document).keyup(function(t){if(!$(t.srcElement).is(":input"))switch(t.which){case 37:e.move_fraction(.25);break;case 38:e.viewport_container.scrollTop(e.viewport_container.scrollTop()-20);break;case 39:e.move_fraction(-.25);break;case 40:e.viewport_container.scrollTop(e.viewport_container.scrollTop()+20)}})}},{key:"handle_unsaved_changes",value:function(e){var t=this;e.has_changes?Galaxy.modal.show({title:(0,h.default)("Close visualization"),body:"There are unsaved changes to your visualization which will be lost if you do not save them.",buttons:{Cancel:function(){Galaxy.modal.hide()},"Leave without Saving":function(){$(window).off("beforeunload"),window.top.location=Galaxy.root+"visualizations/list"},Save:function(){$.when(t.save_viz()).then(function(){window.top.location=Galaxy.root+"visualizations/list"})}}}):window.top.location=Galaxy.root+"visualizations/list"}}]),t}(),G=function(e){function t(e){return v(this,t),w(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return f(t,p.View),j(t,[{key:"initialize",value:function(){var e=this;this.ui=new z(Galaxy.root),this.ui.createButtonMenu(),this.ui.buttonMenu.$el.attr("style","float: right"),$("#center .unified-panel-header-inner").append(this.ui.buttonMenu.$el),$("#right .unified-panel-title").append("Bookmarks"),$("#right .unified-panel-icons").append("<a id='add-bookmark-button' class='icon-button menu-button plus-button' href='javascript:void(0);' title='Add bookmark'></a>"),$("#right-border").click(function(){e.ui.view.resize_window()}),window.force_right_panel("hide"),window.galaxy_config.app.id?this.view_existing():g.default.get("dataset_id")?this.choose_existing_or_new():this.view_new()}},{key:"choose_existing_or_new",value:function(){var e=this,t=g.default.get("dbkey"),i={},a={dbkey:t,dataset_id:g.default.get("dataset_id"),hda_ldda:g.default.get("hda_ldda"),gene_region:g.default.get("gene_region")};t&&(i["f-dbkey"]=t),Galaxy.modal.show({title:"View Data in a New or Saved Visualization?",body:"<p><ul style='list-style: disc inside none'>You can add this dataset as:<li>a new track to one of your existing, saved Trackster sessions if they share the genome build: <b>"+(t||"Not available.")+"</b></li><li>or create a new session with this dataset as the only track</li></ul></p>",buttons:{Cancel:function(){window.top.location=Galaxy.root+"visualizations/list"},"View in saved visualization":function(){e.view_in_saved(a)},"View in new visualization":function(){e.view_new()}}})}},{key:"view_in_saved",value:function(e){var t=this,i=new m.default({url_base:Galaxy.root+"visualization/list_tracks",embedded:!0});Galaxy.modal.show({title:(0,h.default)("Add Data to Saved Visualization"),body:i.$el,buttons:{Cancel:function(){window.top.location=Galaxy.root+"visualizations/list"},"Add to visualization":function(){$(window.parent.document).find("input[name=id]:checked").each(function(){e.id=$(t).val(),window.top.location=Galaxy.root+"visualization/trackster?"+$.param(e)})}}})}},{key:"view_existing",value:function(){var e=window.galaxy_config.app.viz_config;this.ui.create_visualization({container:$("#center .unified-panel-body"),name:e.title,vis_id:e.vis_id,dbkey:e.dbkey},e.viewport,e.tracks,e.bookmarks,!0),this.init_editor()}},{key:"view_new",value:function(){var e=this;$.ajax({url:Galaxy.root+"api/genomes?chrom_info=True",data:{},error:function(){alert("Couldn't create new browser.")},success:function(t){Galaxy.modal.show({title:(0,h.default)("New Visualization"),body:e.template_view_new(t),buttons:{Cancel:function(){window.top.location=Galaxy.root+"visualizations/list"},Create:function(){e.create_browser($("#new-title").val(),$("#new-dbkey").val()),Galaxy.modal.hide()}}});var i=t.map(function(e){return e[1]});window.galaxy_config.app.default_dbkey&&_.contains(i,window.galaxy_config.app.default_dbkey)&&$("#new-dbkey").val(window.galaxy_config.app.default_dbkey),$("#new-title").focus(),$("select[name='dbkey']").select2(),$("#overlay").css("overflow","auto")}})}},{key:"template_view_new",value:function(e){for(var t='<form id="new-browser-form" action="javascript:void(0);" method="post" onsubmit="return false;"><div class="form-row"><label for="new-title">Browser name:</label><div class="form-row-input"><input type="text" name="title" id="new-title" value="Unnamed"></input></div><div style="clear: both;"></div></div><div class="form-row"><label for="new-dbkey">Reference genome build (dbkey): </label><div class="form-row-input"><select name="dbkey" id="new-dbkey">',i=0;i<e.length;i++)t+='<option value="'+e[i][1]+'">'+e[i][0]+"</option>";return t+='</select></div><div style="clear: both;"></div></div><div class="form-row">Is the build not listed here? <a href="'+Galaxy.root+'custom_builds" target="_top">Add a Custom Build</a></div></form>'}},{key:"init_editor",value:function(){var e=this;$("#center .unified-panel-title").text(this.ui.view.config.get_value("name")+" ("+this.ui.view.dbkey+")"),window.galaxy_config.app.add_dataset&&$.ajax({url:Galaxy.root+"api/datasets/"+window.galaxy_config.app.add_dataset,data:{hda_ldda:"hda",data_type:"track_config"},dataType:"json",success:function(t){e.ui.view.add_drawable(y.default.object_from_template(t,e.ui.view,e.ui.view))}}),$("#add-bookmark-button").click(function(){var t=e.ui.view.chrom+":"+e.ui.view.low+"-"+e.ui.view.high;return e.ui.add_bookmark(t,"Bookmark description",!0)}),this.ui.init_keyboard_nav(this.ui.view),$(window).on("beforeunload",function(){if(e.ui.view.has_changes)return"There are unsaved changes to your visualization that will be lost if you leave this page."})}},{key:"create_browser",value:function(e,t){$(document).trigger("convert_to_values"),this.ui.create_visualization({container:$("#center .unified-panel-body"),name:e,dbkey:t},window.galaxy_config.app.gene_region),this.init_editor(),this.ui.view.editor=!0}}]),t}();e.default={TracksterUI:z,GalaxyApp:G}});