define(["libs/bbi/spans","libs/bbi/jszlib","libs/bbi/jquery-ajax-native"],function(e,r){"use strict";function t(){}function n(e){e&&(this.id=e)}function i(e,r){return e[r+3]<<24|e[r+2]<<16|e[r+1]<<8|e[r]}function o(e,r,t){Math.pow(10,6);return $.ajax({type:"GET",dataType:"native",url:e,timeout:5e3,beforeSend:function(e){e.setRequestHeader("Range","bytes="+r+"-"+(r+(t-1)))},xhrFields:{responseType:"arraybuffer"}})}function a(e,r){return e[r]+e[r+1]*p+e[r+2]*b+e[r+3]*x+e[r+4]*I}function s(){}function f(e,r,t,n){this.bwg=e,this.cirTreeOffset=r,this.cirTreeLength=t,this.isSummary=n}function h(e,r,t,n,i){this.bbi=e,this.type=r,this.fieldCount=t,this.offset=n,this.field=i}var u=e.Range,c=e.union,l=e.intersection,m=r.inflateBuffer,d=r.arrayCopy,v=2291137574,g=654086024,w=2273964779,y=3958540679,p=256,b=65536,x=16777216,I=4294967296,z=new RegExp("^[0-9]+,[0-9]+,[0-9]+");return s.prototype.readChromTree=function(){var e=this;this.chromsToIDs={},this.idsToChroms={},this.maxID=0;var r=this.unzoomedDataOffset;return r=r+4-(r-this.chromTreeOffset&3),$.when(o(this.url,this.chromTreeOffset,r-this.chromTreeOffset)).then(function(r){var t=new Uint8Array(r),n=new Int16Array(r),i=new Int32Array(r),o=(i[0],i[1],i[2]),s=(i[3],a(t,16),function(r){var i=t[r],f=n[r/2+1];r+=4;for(var h=0;h<f;++h)if(0===i){var u=a(t,r+=o);r+=8,u-=e.chromTreeOffset,s(u)}else{for(var c="",l=0;l<o;++l){var m=t[r++];0!==m&&(c+=String.fromCharCode(m))}var d=t[r+3]<<24|t[r+2]<<16|t[r+1]<<8|t[r+0];t[r+7],t[r+6],t[r+5],t[r+4];r+=8,e.chromsToIDs[c]=d,0===c.indexOf("chr")&&(e.chromsToIDs[c.substr(3)]=d),e.idsToChroms[d]=c,e.maxID=Math.max(e.maxID,d)}});s(32)})},f.prototype.readWigData=function(e,r,t){var n=this.bwg.chromsToIDs[e];return void 0===n?[]:this.readWigDataById(n,r,t)},f.prototype.readWigDataById=function(e,r,t){var n=this,i=$.Deferred();if(!this.cirHeader)return $.when(o(n.bwg.url,this.cirTreeOffset,48)).then(function(o){n.cirHeader=o;var a=new Int32Array(n.cirHeader);n.cirBlockSize=a[1],$.when(n.readWigDataById(e,r,t)).then(function(e){i.resolve(e)})}),i;var s=[],f=0,h=(Date.now(),function(n,i,o,a){return(e<0||n==e)&&i<=t&&o>=r}),l=function(e,r){if(n.bwg.instrument&&console.log("level="+r+"; offset="+e+"; time="+(0|Date.now())),f+=e.length,1==e.length&&e[0]-n.cirTreeOffset==48&&n.cachedCirRoot)return d(n.cachedCirRoot,0,r),void(0===--f&&$.when(n.fetchFeatures(h,s)).then(function(e){i.resolve(e)}));for(var t,o=4+32*n.cirBlockSize,a=0;a<e.length;++a){var l=new u(e[a],e[a]+o);t=t?c(t,l):l}for(var v=t.ranges(),g=0;g<v.length;++g){var w=v[g];m(e,w,r)}},m=function(e,r,t,a){r.max(),r.min();$.when(o(n.bwg.url,r.min(),r.max()-r.min())).then(function(o){for(var a=0;a<e.length;++a)r.contains(e[a])&&(d(o,e[a]-r.min(),t),e[a]-n.cirTreeOffset==48&&e[a]-r.min()==0&&(n.cachedCirRoot=o),0===--f&&$.when(n.fetchFeatures(h,s)).then(function(e){i.resolve(e)}))})},d=function(n,i,o){var f=new Uint8Array(n),h=new Int16Array(n),u=new Int32Array(n),c=f[i],m=h[i/2+1];if(i+=4,0!==c)for(x=0;x<m;++x){var d=u[I=i/4],v=u[I+1],g=u[I+2],w=u[I+3],y=a(f,i+16),p=a(f,i+24);(e<0||d<e||d==e&&v<=t)&&(e<0||g>e||g==e&&w>=r)&&s.push({offset:y,size:p}),i+=32}else{for(var b=[],x=0;x<m;++x){var I=i/4,d=u[I],v=u[I+1],g=u[I+2],w=u[I+3],y=a(f,i+16);(e<0||d<e||d==e&&v<=t)&&(e<0||g>e||g==e&&w>=r)&&b.push(y),i+=24}b.length>0&&l(b,o+1)}};return l([n.cirTreeOffset+48],1),i},f.prototype.fetchFeatures=function(e,r){var n=this,i=$.Deferred();if(r.sort(function(e,r){return(0|e.offset)-(0|r.offset)}),0===r.length)return[];var a=[],s=function(e,r,i,o){o||(o={});var s=new t;s._chromId=e,s.segment=n.bwg.idsToChroms[e],s.min=r,s.max=i,s.type=n.bwg.type;for(var f in o)s[f]=o[f];a.push(s)},f=function(){if(0===r.length){Date.now();return i.resolve(a)}var t=r[0];if(t.data)n.parseFeatures(t.data,s,e),r.splice(0,1),f();else{for(var h=t.offset,u=t.size,c=1;c<r.length&&r[c].offset==h+u;)u+=r[c].size,++c;$.when(o(n.bwg.url,h,u)).then(function(e){for(var t=0,i=0;t<u;){var o,a=r[i];if(n.bwg.uncompressBufSize>0)o=m(e,t+2,a.size-2);else{var s=new Uint8Array(a.size);d(new Uint8Array(e,t,a.size),0,s,0,a.size),o=s.buffer}a.data=o,t+=a.size,++i}f()})}};return f(),i},f.prototype.parseFeatures=function(e,r,t){var i=new Uint8Array(e);if(this.isSummary)for(var o=new Int16Array(e),a=new Int32Array(e),s=new Float32Array(e),f=e.byteLength/32,h=0;h<f;++h){var m=a[8*h],d=a[8*h+1],v=a[8*h+2],g=a[8*h+3],w=(s[8*h+4],s[8*h+5]),y=s[8*h+6];s[8*h+7];if(t(m,d+1,v)){var p={type:"bigwig",score:y/g,maxScore:w};"bigbed"==this.bwg.type&&(p.type="density"),r(m,d+1,v,p)}}else if("bigwig"==this.bwg.type){var o=new Int16Array(e),a=new Int32Array(e),s=new Float32Array(e),m=a[0],b=a[1],x=(a[2],a[3]),I=a[4],A=i[20],f=o[11];if(3==A)for(h=0;h<f;++h){var O=s[h+6],C=b+h*x+1,D=b+h*x+I;t(m,C,D)&&r(m,C,D,{score:O})}else if(2==A)for(h=0;h<f;++h){var v=(d=a[2*h+6]+1)+I-1,O=s[2*h+7];t(m,d,v)&&r(m,d,v,{score:O})}else if(1==A)for(h=0;h<f;++h){var d=a[3*h+6]+1,v=a[3*h+7],O=s[3*h+8];d>v&&(d=v),t(m,d,v)&&r(m,d,v,{score:O})}else console.log("Currently not handling bwgType="+A)}else{if("bigbed"!=this.bwg.type)throw Error("Don't know what to do with "+this.bwg.type);for(var T=0,F=this.bwg.definedFieldCount,S=this.bwg.schema;T<i.length;){var m=i[T+3]<<24|i[T+2]<<16|i[T+1]<<8|i[T+0],d=i[T+7]<<24|i[T+6]<<16|i[T+5]<<8|i[T+4],v=i[T+11]<<24|i[T+10]<<16|i[T+9]<<8|i[T+8];T+=12;for(var L="";;){var B=i[T++];if(0==B)break;L+=String.fromCharCode(B)}var U,R={};if((U=L.length>0?L.split("\t"):[]).length>0&&F>3&&(R.label=U[0]),U.length>1&&F>4){O=parseInt(U[1]);isNaN(O)||(R.score=O)}if(U.length>2&&F>5&&(R.orientation=U[2]),U.length>5&&F>8){var V=U[5];z.test(V)&&(R.itemRgb="rgb("+V+")")}if(U.length>F-3&&S)for(var j=F-3;j<U.length;++j)R[S.fields[j+3].name]=U[j];if(t(m,d+1,v,U))if(F<12)r(m,d+1,v,R);else{var H=0|U[3],k=0|U[4],W=0|U[6],_=U[7].split(","),N=U[8].split(",");if(R.exonFrames){var Z=R.exonFrames.split(",");R.exonFrames=void 0}R.type="transcript";var E=new n;for(var q in R)E[q]=R[q];if(E.id=U[0],E.segment=this.bwg.idsToChroms[m],E.min=d+1,E.max=v,E.notes=[],R.groups=[E],U.length>9){var M=R.geneName||U[9],Q=M;U.length>10&&(Q=U[10]),R.geneName2&&(Q=R.geneName2);var G=$.extend({},E);G.id=M,G.label=Q,G.type="gene",R.groups.push(G)}for(var J=[],K=0;K<W;++K){var P=(0|N[K])+d,X=P+(0|_[K]),Y=new u(P,X);J.push(Y)}for(var ee=c(J),re=ee.ranges(),te=0;te<re.length;++te)r(m,(he=re[te]).min()+1,he.max(),R);if(k>H){var ne="+"==R.orientation?new u(H,k+3):new u(H-3,k),ie=l(ee,ne);if(ie){R.type="translation";for(var oe=ie.ranges(),ae=0,se=0;oe[0].min()>re[se].max();)se++;for(te=0;te<oe.length;++te){var fe=te;"-"==R.orientation&&(fe=oe.length-te-1);var he=oe[fe];if(R.readframe=ae,Z){var ue=parseInt(Z[fe+se]);"number"==typeof ue&&ue>=0&&ue<=2&&(R.readframe=ue,R.readframeExplicit=!0)}ae=(ae+(he.max()-he.min()))%3,r(m,he.min()+1,he.max(),R)}}}}}}},f.prototype.getFirstAdjacent=function(e,r,t,n){var i=this.bwg.chromsToIDs[e];if(void 0===i)return n([]);this.getFirstAdjacentById(i,r,t,n)},f.prototype.getFirstAdjacentById=function(e,r,t,n){var i=this;if(this.cirHeader){var o=null,s=-1,f=-1,h=0,l=(Date.now(),function(e,r){h+=e.length;for(var t,n=4+32*i.cirBlockSize,o=0;o<e.length;++o){var a=new u(e[o],e[o]+n);t=t?c(t,a):a}for(var s=t.ranges(),f=0;f<s.length;++f){var l=s[f];m(e,l,r)}}),m=function(a,s,f,u){s.max(),s.min();i.bwg.data.slice(s.min(),s.max()-s.min()).fetch(function(u){for(var c=0;c<a.length;++c)if(s.contains(a[c])&&(d(u,a[c]-s.min(),f),0==--h)){if(!o)return t>0&&(0!=e||r>0)?i.getFirstAdjacentById(0,0,t,n):t<0&&(e!=i.bwg.maxID||r<1e9)?i.getFirstAdjacentById(i.bwg.maxID,1e9,t,n):n([]);i.fetchFeatures(function(n,i,o,a){return t<0&&(n<e||o<r)||t>0&&(n>e||i>r)},[o],function(e){for(var r=null,i=-1,o=-1,a=0;a<e.length;++a){var s=e[a],f=s._chromId,h=s.min,u=s.max;(null==r||t<0&&(f>i||u>o)||t>0&&(f<i||h<o))&&(r=s,o=t<0?u:h,i=f)}return n(null!=r?[r]:[])})}})},d=function(n,h,u){var c=new Uint8Array(n),m=new Int16Array(n),d=new Int32Array(n),v=c[h],g=m[h/2+1];if(h+=4,0!=v)for(O=0;O<g;++O){var w=d[C=h/4],y=d[C+1],p=d[C+2],b=d[C+3],x=a(c,h+16),I=a(c,h+24);(t<0&&(w<e||w==e&&y<=r)||t>0&&(p>e||p==e&&b>=r))&&(/_random/.exec(i.bwg.idsToChroms[w])||(null==o||t<0&&(p>s||p==s&&b>f)||t>0&&(w<s||w==s&&y<f))&&(o={offset:x,size:I},f=t<0?b:y,s=t<0?p:w)),h+=32}else{for(var z=-1,A=-1,O=0;O<g;++O){var C=h/4,w=d[C],y=d[C+1],p=d[C+2],b=d[C+3],x=d[C+4]<<32|d[C+5];(t<0&&(w<e||w==e&&y<=r)&&p>=e||t>0&&(p>e||p==e&&b>=r)&&w<=e)&&(z<0||b>A)&&(z=x,A=t<0?b:y,t<0?p:w),h+=24}z>=0&&l([z],u+1)}};l([i.cirTreeOffset+48],1)}else this.bwg.data.slice(this.cirTreeOffset,48).fetch(function(o){i.cirHeader=o;var a=new Int32Array(i.cirHeader);i.cirBlockSize=a[1],i.getFirstAdjacentById(e,r,t,n)})},s.prototype.readWigData=function(e,r,t){var n,i=t-r;if(i<=25e3||0===this.zoomLevels.length)n=this.getUnzoomedView();else for(var o=0;o<this.zoomLevels.length;o++)if(i/this.zoomLevels[o].reduction<25e3){n=this.getZoomedView(o);break}return n.readWigData(e,r,t)},s.prototype.getUnzoomedView=function(){if(!this.unzoomedView){var e=4e3;this.zoomLevels[0]&&(e=this.zoomLevels[0].dataOffset-this.unzoomedIndexOffset),this.unzoomedView=new f(this,this.unzoomedIndexOffset,e,!1)}return this.unzoomedView},s.prototype.getZoomedView=function(e){var r=this.zoomLevels[e];return r.view||(r.view=new f(this,r.indexOffset,4e3,!0)),r.view},s.prototype._tsFetch=function(e,r,t,n,i){var o=this;if(!(e>=this.zoomLevels.length-1)){return(e<0?this.getUnzoomedView():this.getZoomedView(e)).readWigDataById(r,t,n,i)}if(this.topLevelReductionCache){for(var a=[],s=this.topLevelReductionCache,f=0;f<s.length;++f)s[f]._chromId==r&&a.push(s[f]);return i(a)}this.getZoomedView(this.zoomLevels.length-1).readWigDataById(-1,0,3e8,function(a){return o.topLevelReductionCache=a,o._tsFetch(e,r,t,n,i)})},s.prototype.thresholdSearch=function(e,r,t,n,i){function o(){if(0==f.length)return i(null);f.sort(function(e,r){var n=e.zoom-r.zoom;return 0!=n?n:0!=(n=e.chrOrd-r.chrOrd)?n:e.min-r.min*t});var e=f.splice(0,1)[0];a._tsFetch(e.zoom,e.chr,e.min,e.max,function(a){var s=t>0?0:3e8;e.fromRef&&(s=r);for(var h=0;h<a.length;++h){var u,c=a[h];if(u=void 0!=c.maxScore?c.maxScore:c.score,t>0){if(u>n)if(e.zoom<0){if(c.min>s)return i(c)}else c.max>s&&f.push({chr:e.chr,chrOrd:e.chrOrd,zoom:e.zoom-2,min:c.min,max:c.max,fromRef:e.fromRef})}else if(u>n)if(e.zoom<0){if(c.max<s)return i(c)}else c.min<s&&f.push({chr:e.chr,chrOrd:e.chrOrd,zoom:e.zoom-2,min:c.min,max:c.max,fromRef:e.fromRef})}o()})}t=t<0?-1:1;for(var a=this,s=this.chromsToIDs[e],f=[{chrOrd:0,chr:s,zoom:a.zoomLevels.length-4,min:0,max:3e8,fromRef:!0}],h=1;h<=this.maxID+1;++h){var u=(s+t*h)%(this.maxID+1);u<0&&(u+=this.maxID+1),f.push({chrOrd:h,chr:u,zoom:a.zoomLevels.length-1,min:0,max:3e8})}o()},s.prototype.getAutoSQL=function(e){if(!this.asOffset)return e(null);$.when(o(this.url,this.asOffset,2048)).then(function(r){for(var t=new Uint8Array(r),n="",i=0;i<t.length&&0!=t[i];++i)n+=String.fromCharCode(t[i]);var o=/([\w\[\]]+)\s+(\w+)\s*;\s*("([^"]+)")?\s*/g,a=/(\w+)\s+(\w+)\s+("([^"]+)")?\s+\(\s*/.exec(n);if(a){var s={declType:a[1],name:a[2],comment:a[4],fields:[]};n=n.substring(a[0]);for(var f=o.exec(n);null!=f;f=o.exec(n))s.fields.push({type:f[1],name:f[2],comment:f[4]});return e(s)}})},s.prototype.getExtraIndices=function(e){var r=this;if(this.version<4||0==this.extHeaderOffset||"bigbed"!=this.type)return e(null);this.data.slice(this.extHeaderOffset,64).fetch(function(t){if(!t)return e(null,"Couldn't fetch extension header");var n=new Uint8Array(t),i=new Int16Array(t),o=(new Int32Array(t),i[0],i[1]),s=a(n,4);if(0==o)return e(null);r.data.slice(s,20*o).fetch(function(t){if(!t)return e(null,"Couldn't fetch index info");for(var n=new Uint8Array(t),i=new Int16Array(t),s=(new Int32Array(t),[]),f=0;f<o;++f){var u=i[10*f],c=i[10*f+1],l=a(n,20*f+4),m=i[10*f+8],d=new h(r,u,c,l,m);s.push(d)}e(s)})})},h.prototype.lookup=function(e,r){var t=this;this.bbi.data.slice(this.offset,32).fetch(function(n){function o(n){t.bbi.data.slice(n,4+h*(u+c)).fetch(function(n){var s=new Uint8Array(n),f=new Uint16Array(n),h=(new Uint32Array(n),s[0]),l=f[1],m=4;if(0!=h){for(b=0;b<l;++b){for(var d="",v=0;v<u;++v){var g=s[m++];0!=g&&(d+=String.fromCharCode(g))}if(d==e){var w=a(s,m),y=i(s,m+8);return t.bbi.getUnzoomedView().fetchFeatures(function(r,n,i,o){if(o&&o.length>t.field-3)return o[t.field-3]==e},[{offset:w,size:y}],r)}m+=c}return r([])}for(var p=null,b=0;b<l;++b){for(var d="",v=0;v<u;++v)0!=(g=s[m++])&&(d+=String.fromCharCode(g));var x=a(s,m);if(m+=8,e.localeCompare(d)<0&&p)return void o(p);p=x}o(p)})}var s=new Uint8Array(n),f=(new Int16Array(n),new Int32Array(n)),h=(f[0],f[1]),u=f[2],c=f[3];a(s,16);o(t.offset+32)})},{makeBwg:function(e){var r=$.Deferred(),t=new s;return t.url=e,$.when(o(t.url,0,512)).then(function(e){if(!e)return r.resolve(null,"Couldn't fetch file");var n=e,i=new Uint8Array(n),o=new Int16Array(n),s=new Int32Array(n),f=i[0]+p*i[1]+b*i[2]+x*i[3];if(f==v)t.type="bigwig";else{if(f!=w)return f==g||f==y?r.resolve(null,"Currently don't support big-endian BBI files"):r.resolve(null,"Not a supported format, magic=0x"+f.toString(16));t.type="bigbed"}t.version=o[2],t.numZoomLevels=o[3],t.chromTreeOffset=a(i,8),t.unzoomedDataOffset=a(i,16),t.unzoomedIndexOffset=a(i,24),t.fieldCount=o[16],t.definedFieldCount=o[17],t.asOffset=a(i,36),t.totalSummaryOffset=a(i,44),t.uncompressBufSize=s[13],t.extHeaderOffset=a(i,56),t.zoomLevels=[];for(var h=0;h<t.numZoomLevels;++h){var u=s[6*h+16],c=a(i,24*h+72),l=a(i,24*h+80);t.zoomLevels.push({reduction:u,dataOffset:c,indexOffset:l})}$.when(t.readChromTree()).then(function(){t.getAutoSQL(function(e){return t.schema=e,r.resolve(t)})})}),r}}});