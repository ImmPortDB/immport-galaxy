define("legacy/grid/grid-view",["exports","utils/utils","legacy/grid/grid-model","legacy/grid/grid-template","mvc/ui/popup-menu"],function(t,i,e,r,n){"use strict";function a(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(t,"__esModule",{value:!0});var s=a(i),o=a(e),d=a(r),l=a(n);jQuery.ajaxSettings.traditional=!0,t.default=Backbone.View.extend({grid:null,initialize:function(t){this.grid=new o.default,this.dict_format=t.dict_format,this.title=t.title,this.title_id=t.title_id;var i=this;if(window.add_tag_to_grid_filter=function(t,e){var r=t+(void 0!==e&&""!==e?":"+e:"");$("#advanced-search").is(":visible")||($("#standard-search").slideToggle("fast"),$("#advanced-search").slideToggle("fast")),i.add_filter_condition("tags",r)},this.dict_format)if(this.setElement("<div/>"),t.url_base&&!t.items){var e=t.url_data||{};_.each(t.filters,function(t,i){e["f-"+i]=t}),$.ajax({url:t.url_base+"?"+$.param(e),success:function(e){e.embedded=t.embedded,e.filters=t.filters||{},i.init_grid(e)}})}else this.init_grid(t);else this.setElement("#grid-container"),this.init_grid(t);t.use_panels&&$("#center").css({padding:"10px",overflow:"auto"})},handle_refresh:function(t){t&&$.inArray("history",t)>-1&&window.top.Galaxy&&window.top.Galaxy.currHistoryPanel&&window.top.Galaxy.currHistoryPanel.loadCurrentHistory()},init_grid:function(t){this.grid.set(t);var i=this.grid.attributes;this.allow_title_display&&i.title&&s.default.setWindowTitle(i.title),this.handle_refresh(i.refresh_frames);var e=this.grid.get("url_base");if(e=e.replace(/^.*\/\/[^\/]+/,""),this.grid.set("url_base",e),this.$el.html(d.default.grid(i)),this.$el.find("#grid-table-header").html(d.default.header(i)),this.$el.find("#grid-table-body").html(d.default.body(i)),this.$el.find("#grid-table-footer").html(d.default.footer(i)),i.message){this.$el.find("#grid-message").html(d.default.message(i));var r=this;i.use_hide_message&&setTimeout(function(){r.$el.find("#grid-message").html("")},5e3)}this.init_grid_elements(),this.init_grid_controls(),window.init_refresh_on_change&&window.init_refresh_on_change()},init_grid_controls:function(){var t=this;this.$el.find(".operation-button").each(function(){$(this).off(),$(this).click(function(){return t.submit_operation(this),!1})}),this.$el.find("input[type=text]").each(function(){$(this).off(),$(this).click(function(){$(this).select()}).keyup(function(){$(this).css("font-style","normal")})}),this.$el.find(".sort-link").each(function(){$(this).off(),$(this).click(function(){return t.set_sort_condition($(this).attr("sort_key")),!1})}),this.$el.find(".text-filter-form").each(function(){$(this).off(),$(this).submit(function(){var i=$(this).attr("column_key"),e=$("#input-"+i+"-filter"),r=e.val();return e.val(""),t.add_filter_condition(i,r),!1})}),this.$el.find(".text-filter-val > a").each(function(){$(this).off(),$(this).click(function(){return $(this).parent().remove(),t.remove_filter_condition($(this).attr("filter_key"),$(this).attr("filter_val")),!1})}),this.$el.find(".categorical-filter > a").each(function(){$(this).off(),$(this).click(function(){return t.set_categorical_filter($(this).attr("filter_key"),$(this).attr("filter_val")),!1})}),this.$el.find(".advanced-search-toggle").each(function(){$(this).off(),$(this).click(function(){return t.$el.find("#standard-search").slideToggle("fast"),t.$el.find("#advanced-search").slideToggle("fast"),!1})}),this.$el.find("#check_all").off(),this.$el.find("#check_all").on("click",function(){t.check_all_items()})},init_grid_elements:function(){this.$el.find(".grid").each(function(){var t=$(this).find("input.grid-row-select-checkbox"),i=$(this).find("span.grid-selected-count"),e=function(){i.text($(t).filter(":checked").length)};$(t).each(function(){$(this).change(e)}),e()}),0!==this.$el.find(".community_rating_star").length&&this.$el.find(".community_rating_star").rating({});var t=this.grid.attributes,i=this;this.$el.find(".page-link > a").each(function(){$(this).click(function(){return i.set_page($(this).attr("page_num")),!1})}),this.$el.find(".use-target").each(function(){$(this).click(function(){return i.execute({href:$(this).attr("href"),target:$(this).attr("target")}),!1})}),0!==t.items.length&&_.each(t.items,function(e,r){var n=i.$("#grid-"+e.encode_id+"-popup").off(),a=new l.default(n);_.each(t.operations,function(t){i._add_operation(a,t,e)})})},_add_operation:function(t,i,e){var r=this,n=e.operation_config[i.label];n.allowed&&i.allow_popup&&t.addItem({html:i.label,href:n.url_args,target:n.target,confirmation_text:i.confirm,func:function(t){t.preventDefault();var n=$(t.target).html();i.onclick?i.onclick(e.encode_id):r.execute(this.findItemByHtml(n))}})},add_filter_condition:function(t,i){if(""===i)return!1;this.grid.add_filter(t,i,!0);var e=$(d.default.filter_element(t,i)),r=this;e.click(function(){$(this).remove(),r.remove_filter_condition(t,i)}),this.$el.find("#"+t+"-filtering-criteria").append(e),this.go_page_one(),this.execute()},remove_filter_condition:function(t,i){this.grid.remove_filter(t,i),this.go_page_one(),this.execute()},set_sort_condition:function(t){var i=this.grid.get("sort_key"),e=t;-1!==i.indexOf(t)&&"-"!==i.substring(0,1)&&(e="-"+t),this.$el.find(".sort-arrow").remove();var r="-"==e.substring(0,1)?"&uarr;":"&darr;",n=$("<span>"+r+"</span>").addClass("sort-arrow");this.$el.find("#"+t+"-header").append(n),this.grid.set("sort_key",e),this.go_page_one(),this.execute()},set_categorical_filter:function(t,i){var e=this.grid.get("categorical_filters")[t],r=this.grid.get("filters")[t],n=this;this.$el.find("."+t+"-filter").each(function(){var a=$.trim($(this).text()),s=e[a][t];if(s==i)$(this).empty(),$(this).addClass("current-filter"),$(this).append(a);else if(s==r){$(this).empty();var o=$('<a href="#">'+a+"</a>");o.click(function(){n.set_categorical_filter(t,s)}),$(this).removeClass("current-filter"),$(this).append(o)}}),this.grid.add_filter(t,i),this.go_page_one(),this.execute()},set_page:function(t){var i=this;this.$el.find(".page-link").each(function(){var e,r=$(this).attr("id"),n=parseInt(r.split("-")[2],10),a=i.grid.get("cur_page");if(n===t)e=$(this).children().text(),$(this).empty(),$(this).addClass("inactive-link"),$(this).text(e);else if(n===a){e=$(this).text(),$(this).empty(),$(this).removeClass("inactive-link");var s=$('<a href="#">'+e+"</a>");s.click(function(){i.set_page(n)}),$(this).append(s)}}),"all"===t?this.grid.set("cur_page",t):this.grid.set("cur_page",parseInt(t,10)),this.execute()},submit_operation:function(t,i){var e=$(t).val();if(this.$el.find('input[name="id"]:checked').length<1)return!1;var r=_.findWhere(this.grid.attributes.operations,{label:e});r&&!i&&(i=r.confirm||"");var n=[];this.$el.find("input[name=id]:checked").each(function(){n.push($(this).val())});var a={operation:e,id:n,confirmation_text:i};return"top"!=r.target&&"center"!=r.target||(a=_.extend(a,{href:r.href,target:r.target})),this.execute(a),!0},check_all_items:function(){var t=this.$(".grid-row-select-checkbox"),i=this.$("#check_all").prop("checked");_.each(t,function(t){$(t).prop("checked",i)}),this.init_grid_elements()},go_page_one:function(){var t=this.grid.get("cur_page");null!==t&&void 0!==t&&"all"!==t&&this.grid.set("cur_page",1)},execute:function(t){var i=null,e=null,r=null,n=null,a=null;if(t&&(e=t.href,r=t.operation,i=t.id,n=t.confirmation_text,a=t.target,void 0!==e&&-1!=e.indexOf("operation="))){var s=e.split("?");if(s.length>1)for(var o=s[1].split("&"),d=0;d<o.length;d++)-1!=o[d].indexOf("operation")?r=(r=o[d].split("=")[1]).replace(/\+/g," "):-1!=o[d].indexOf("id")&&(i=o[d].split("=")[1])}return r&&i?!(n&&""!==n&&"None"!=n&&"null"!=n&&!confirm(n))&&(r=r.toLowerCase(),this.grid.set({operation:r,item_ids:i}),"top"==a?window.top.location=e+"?"+$.param(this.grid.get_url_data()):"center"==a?$("#galaxy_main").attr("src",e+"?"+$.param(this.grid.get_url_data())):this.grid.can_async_op(r)||this.dict_format?this.update_grid():this.go_to(a,e),!1):e?(this.go_to(a,e),!1):(this.grid.get("async")||this.dict_format?this.update_grid():this.go_to(a,e),!1)},go_to:function(t,i){var e=this.grid.get("async");this.grid.set("async",!1);var r=this.$el.find("#advanced-search").is(":visible");switch(this.grid.set("advanced_search",r),i||(i=this.grid.get("url_base")+"?"+$.param(this.grid.get_url_data())),this.grid.set({operation:void 0,item_ids:void 0,async:e}),t){case"center":$("#galaxy_main").attr("src",i);break;case"top":window.top.location=i;break;default:window.location=i}},update_grid:function(){var t=this.grid.get("operation")?"POST":"GET";this.$el.find(".loading-elt-overlay").show();var i=this;$.ajax({type:t,url:i.grid.get("url_base"),data:i.grid.get_url_data(),error:function(){alert("Grid refresh failed")},success:function(t){var e=i.grid.get("embedded"),r=i.grid.get("insert"),n=i.$el.find("#advanced-search").is(":visible"),a=i.dict_format?t:$.parseJSON(t);a.embedded=e,a.insert=r,a.advanced_search=n,i.init_grid(a),i.$el.find(".loading-elt-overlay").hide()},complete:function(){i.grid.set({operation:void 0,item_ids:void 0})}})}})});