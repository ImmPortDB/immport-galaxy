define("mvc/base/controlled-fetch-collection",["exports","libs/underscore","libs/backbone","mvc/base-mvc"],function(t,e,i,r){"use strict";function n(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}Object.defineProperty(t,"__esModule",{value:!0});var a=n(e),o=n(i),l=function(t){return t&&t.__esModule?t:{default:t}}(r),c=o.Collection.extend({initialize:function(t,e){o.Collection.prototype.initialize.call(this,t,e),this.setOrder(e.order||this.order,{silent:!0})},_setUpListeners:function(){return this.on({"changed-order":this.sort})},fetch:function(t){return t=this._buildFetchOptions(t),Galaxy.debug("fetch options:",t),o.Collection.prototype.fetch.call(this,t)},_buildFetchOptions:function(t){(t=a.clone(t)||{}).traditional=!0,t.data=t.data||this._buildFetchData(t),Galaxy.debug("data:",t.data);var e=this._buildFetchFilters(t);return Galaxy.debug("filters:",e),a.isEmpty(e)||a.extend(t.data,this._fetchFiltersToAjaxData(e)),Galaxy.debug("data:",t.data),t},_buildFetchData:function(t){var e={};return this.order&&(e.order=this.order),a.defaults(a.pick(t,this._fetchParams),e)},_fetchParams:["order","limit","offset","view","keys"],_buildFetchFilters:function(t){return a.clone(t.filters||{})},_fetchFiltersToAjaxData:function(t){var e={q:[],qv:[]};return a.each(t,function(t,i){void 0!==t&&""!==t&&(!0===t&&(t="True"),!1===t&&(t="False"),null===t&&(t="None"),e.q.push(i),e.qv.push(t))}),e},reset:function(t,e){return this.allFetched=!1,o.Collection.prototype.reset.call(this,t,e)},order:null,comparators:{update_time:l.default.buildComparator("update_time",{ascending:!1}),"update_time-asc":l.default.buildComparator("update_time",{ascending:!0}),create_time:l.default.buildComparator("create_time",{ascending:!1}),"create_time-asc":l.default.buildComparator("create_time",{ascending:!0})},setOrder:function(t,e){e=e||{};var i=this,r=i.comparators[t];if(a.isUndefined(r))throw new Error("unknown order: "+t);if(r!==i.comparator)return i.order=t,i.comparator=r,e.silent||i.trigger("changed-order",e),i}}),s=c.extend({limitPerPage:500,initialize:function(t,e){c.prototype.initialize.call(this,t,e),this.currentPage=e.currentPage||0},getTotalItemCount:function(){return this.length},shouldPaginate:function(){return this.getTotalItemCount()>=this.limitPerPage},getLastPage:function(){return Math.floor(this.getTotalItemCount()/this.limitPerPage)},getPageCount:function(){return this.getLastPage()+1},getPageLimitOffset:function(t){return t=this.constrainPageNum(t),{limit:this.limitPerPage,offset:t*this.limitPerPage}},constrainPageNum:function(t){return Math.max(0,Math.min(t,this.getLastPage()))},fetchPage:function(t,e){var i=this;return t=i.constrainPageNum(t),i.currentPage=t,e=a.defaults(e||{},i.getPageLimitOffset(t)),i.trigger("fetching-more"),i.fetch(e).always(function(){i.trigger("fetching-more-done")})},fetchCurrentPage:function(t){return this.fetchPage(this.currentPage,t)},fetchPrevPage:function(t){return this.fetchPage(this.currentPage-1,t)},fetchNextPage:function(t){return this.fetchPage(this.currentPage+1,t)}}),h=c.extend({limitOnFirstFetch:null,limitPerFetch:100,initialize:function(t,e){c.prototype.initialize.call(this,t,e),this.limitOnFirstFetch=e.limitOnFirstFetch||this.limitOnFirstFetch,this.limitPerFetch=e.limitPerFetch||this.limitPerFetch,this.allFetched=!1,this.lastFetched=e.lastFetched||0},_buildFetchOptions:function(t){return t.remove=t.remove||!1,c.prototype._buildFetchOptions.call(this,t)},fetchFirst:function(t){return Galaxy.debug("ControlledFetchCollection.fetchFirst:",t),t=t?a.clone(t):{},this.allFetched=!1,this.lastFetched=0,this.fetchMore(a.defaults(t,{reset:!0,limit:this.limitOnFirstFetch}))},fetchMore:function(t){Galaxy.debug("ControlledFetchCollection.fetchMore:",t),t=a.clone(t||{});var e=this;if(Galaxy.debug("fetchMore, options.reset:",t.reset),!t.reset&&e.allFetched)return jQuery.when();t.reset?t.offset=0:void 0===t.offset&&(t.offset=e.lastFetched);var i=t.limit=t.limit||e.limitPerFetch||null;return Galaxy.debug("fetchMore, limit:",i,"offset:",t.offset),e.trigger("fetching-more"),e.fetch(t).always(function(){e.trigger("fetching-more-done")}).done(function(t){var r=a.isArray(t)?t.length:0;e.lastFetched+=r,Galaxy.debug("fetchMore, lastFetched:",e.lastFetched),(!i||r<i)&&(e.allFetched=!0,e.trigger("all-fetched",this))})},fetchAll:function(t){t=t||{};var e=this;return t=a.pick(t,"silent"),t.filters={},e.fetch(t).done(function(){e.allFetched=!0,e.trigger("all-fetched",e)})}});t.default={ControlledFetchCollection:c,PaginatedCollection:s,InfinitelyScrollingCollection:h}});