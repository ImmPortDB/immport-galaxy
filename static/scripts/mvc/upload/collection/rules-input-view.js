define("mvc/upload/collection/rules-input-view",["exports","utils/localization","mvc/ui/ui-misc","mvc/ui/ui-select","mvc/upload/upload-utils","axios"],function(t,e,a,i,n,s){"use strict";function l(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(t,"__esModule",{value:!0});var o=l(e),d=l(a),u=l(i),c=l(n),r=l(s);t.default=Backbone.View.extend({initialize:function(t){var e=this;this.app=t,this.options=t.options,this.ftpFiles=[],this.ftpUploadSite=t.currentFtp(),this.setElement(this._template()),this.btnBuild=new d.default.Button({id:"btn-build",title:(0,o.default)("Build"),onclick:function(){e._eventBuild()}}),this.btnBuild.$el.addClass("btn-primary"),this.btnReset=new d.default.Button({id:"btn-reset",title:(0,o.default)("Reset"),onclick:function(){return e._eventReset()}}),this.btnClose=new d.default.Button({id:"btn-close",title:(0,o.default)("Close"),onclick:function(){return e.app.modal.hide()}}),_.each([this.btnReset,this.btnBuild,this.btnClose],function(t){e.$(".upload-buttons").prepend(t.$el)});var a=[{id:"datasets",text:"Datasets"},{id:"collections",text:"Collection(s)"}];this.dataType="datasets",this.dataTypeView=new u.default.View({css:"upload-footer-selection",container:this.$(".rule-data-type"),data:a,value:this.dataType,onchange:function(t){e.dataType=t}});var i=[{id:"paste",text:"Pasted Table"},{id:"dataset",text:"History Dataset"}];this.ftpUploadSite&&i.push({id:"ftp",text:"FTP Directory"}),this.selectionType="paste",this.selectionTypeView=new u.default.View({css:"upload-footer-selection",container:this.$(".rule-select-type"),data:i,value:this.selectionType,onchange:function(t){e.selectionType=t,e._renderSelectedType()}}),this.selectedDatasetId=null,this.$sourceContent=this.$(".upload-rule-source-content"),this.$sourceContent.on("change keyup paste",function(){e._updateBuildState()}),this._renderSelectedType()},_renderSelectedType:function(){var t=this,e=this.selectionType;if("dataset"==e)if(this.datasetSelectorView)this.datasetSelectorView.value(null);else{this.selectedDatasetId=null;var a=(parent.Galaxy&&parent.Galaxy.currHistoryPanel&&parent.Galaxy.currHistoryPanel.model).contents.models,i=[],n=!0,s=!1,l=void 0;try{for(var d,r=a[Symbol.iterator]();!(n=(d=r.next()).done);n=!0){var p=d.value.attributes;"dataset"===p.history_content_type&&i.push({id:p.id,text:p.hid+": "+_.escape(p.name)})}}catch(t){s=!0,l=t}finally{try{!n&&r.return&&r.return()}finally{if(s)throw l}}this.datasetSelectorView=new u.default.View({container:this.$(".dataset-selector"),data:i,placeholder:(0,o.default)("Select a dataset"),onchange:function(e){t._onDataset(e)}})}else"ftp"==e&&c.default.getRemoteFiles(function(e){t._setPreview(e.map(function(t){return t.path}).join("\n")),t.ftpFiles=e});this._updateScreen()},_onDataset:function(t){var e=this;this.selectedDatasetId=t,t?r.default.get(Galaxy.root+"api/histories/"+Galaxy.currHistoryPanel.model.id+"/contents/"+t+"/display").then(function(t){e._setPreview(t.data)}).catch(function(t){return console.log(t)}):this._setPreview("")},_eventReset:function(){this.datasetSelectorView&&this.datasetSelectorView.value(null),this.$sourceContent.val(""),this._updateScreen()},_eventBuild:function(){var t=this.$sourceContent.val();this._buildSelection(t)},_buildSelection:function(t){var e=this.selectionType,a={};"dataset"==e||"paste"==e?(a.selectionType="raw",a.content=t):"ftp"==e&&(a.selectionType="ftp",a.elements=this.ftpFiles,a.ftpUploadSite=this.ftpUploadSite),a.dataType=this.dataType,Galaxy.currHistoryPanel.buildCollection("rules",a,!0),this.app.modal.hide()},_setPreview:function(t){this.$sourceContent.val(t),this._updateScreen()},_updateScreen:function(){this._updateBuildState();var t=this.selectionType;this.$("#upload-rule-dataset-option")["dataset"==t?"show":"hide"](),this.$sourceContent.attr("disabled","paste"!==t)},_updateBuildState:function(){var t=this.$sourceContent.val();this.btnBuild[t?"enable":"disable"](),this.btnBuild.$el[t?"addClass":"removeClass"]("btn-primary")},_template:function(){return'\n            <div class="upload-view-default">\n                <div class="upload-top">\n                    <h6 class="upload-top-info">\n                        Tabular source data to extract collection files and metadata from\n                    </h6>\n                </div>\n                <div class="upload-box" style="height: 335px;">\n                    <span style="width: 25%; display: inline; height: 100%" class="float-left">\n                        <div class="upload-rule-option">\n                            <div class="upload-rule-option-title">'+(0,o.default)("Upload data as")+':</div>\n                            <div class="rule-data-type" />\n                        </div>\n                        <div class="upload-rule-option">\n                            <div class="upload-rule-option-title">'+(0,o.default)("Load tabular data from")+':</div>\n                            <div class="rule-select-type" />\n                        </div>\n                        <div id="upload-rule-dataset-option" class="upload-rule-option">\n                            <div class="upload-rule-option-title">'+(0,o.default)("Select dataset to load")+':</div>\n                            <div class="dataset-selector" />\n                        </div>\n                    </span>\n                    <span style="display: inline; float: right; width: 75%; height: 300px">\n                    <textarea class="upload-rule-source-content form-control" style="height: 100%"></textarea>\n                    </span>\n                </div>\n                <div class="clear" />\n                \x3c!--\n                <div class="upload-footer">\n                </div>\n                --\x3e\n                <div class="upload-buttons"/>\n                </div>\n        '}})});