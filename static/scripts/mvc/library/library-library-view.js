define(["libs/toastr","mvc/library/library-model","mvc/ui/ui-select"],function(a,b,c){var d=Backbone.View.extend({el:"#center",model:null,options:{},events:{"click .toolbtn_save_permissions":"savePermissions"},initialize:function(a){this.options=_.extend(this.options,a),this.options.id&&this.fetchLibrary()},fetchLibrary:function(c){this.options=_.extend(this.options,c),this.model=new b.Library({id:this.options.id});var d=this;this.model.fetch({success:function(){d.options.show_permissions?d.showPermissions():d.render()},error:function(b,c){"undefined"!=typeof c.responseJSON?a.error(c.responseJSON.err_msg+" Click this to go back.","",{onclick:function(){Galaxy.libraries.library_router.back()}}):a.error("An error ocurred. Click this to go back.","",{onclick:function(){Galaxy.libraries.library_router.back()}})}})},render:function(a){$(".tooltip").remove(),this.options=_.extend(this.options,a);var b=this.templateLibrary();this.$el.html(b({item:this.model})),$("#center [data-toggle]").tooltip()},shareDataset:function(){a.info("Feature coming soon.")},goBack:function(){Galaxy.libraries.library_router.back()},showPermissions:function(b){this.options=_.extend(this.options,b),$(".tooltip").remove(),void 0!==this.options.fetched_permissions&&this.model.set(0===this.options.fetched_permissions.access_library_role_list.length?{is_unrestricted:!0}:{is_unrestricted:!1});var c=!1;Galaxy.user&&(c=Galaxy.user.isAdmin());var d=this.templateLibraryPermissions();this.$el.html(d({library:this.model,is_admin:c}));var e=this;void 0===this.options.fetched_permissions?$.get(Galaxy.root+"api/libraries/"+e.id+"/permissions?scope=current").done(function(a){e.prepareSelectBoxes({fetched_permissions:a})}).fail(function(){a.error("An error occurred while attempting to fetch library permissions.")}):this.prepareSelectBoxes({}),$("#center [data-toggle]").tooltip(),$("#center").css("overflow","auto")},_serializeRoles:function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c][1]+":"+a[c][0]);return b},prepareSelectBoxes:function(a){this.options=_.extend(this.options,a);var b=this.options.fetched_permissions,d=this,e=this._serializeRoles(b.access_library_role_list),f=this._serializeRoles(b.add_library_item_role_list),g=this._serializeRoles(b.manage_library_role_list),h=this._serializeRoles(b.modify_library_role_list);d.accessSelectObject=new c.View(this._createSelectOptions(this,"access_perm",e,!0)),d.addSelectObject=new c.View(this._createSelectOptions(this,"add_perm",f,!1)),d.manageSelectObject=new c.View(this._createSelectOptions(this,"manage_perm",g,!1)),d.modifySelectObject=new c.View(this._createSelectOptions(this,"modify_perm",h,!1))},_createSelectOptions:function(a,b,c,d){d=d===!0?d:!1;var e={minimumInputLength:0,css:b,multiple:!0,placeholder:"Click to select a role",container:a.$el.find("#"+b),ajax:{url:Galaxy.root+"api/libraries/"+a.id+"/permissions?scope=available&is_library_access="+d,dataType:"json",quietMillis:100,data:function(a,b){return{q:a,page_limit:10,page:b}},results:function(a,b){var c=10*b<a.total;return{results:a.roles,more:c}}},formatResult:function(a){return a.name+" type: "+a.type},formatSelection:function(a){return a.name},initSelection:function(a,b){var c=[];$(a.val().split(",")).each(function(){var a=this.split(":");c.push({id:a[0],name:a[1]})}),b(c)},initialData:c,dropdownCssClass:"bigdrop"};return e},comingSoon:function(){a.warning("Feature coming soon.")},copyToClipboard:function(){var a=Backbone.history.location.href;-1!==a.lastIndexOf("/permissions")&&(a=a.substr(0,a.lastIndexOf("/permissions"))),window.prompt("Copy to clipboard: Ctrl+C, Enter",a)},makeDatasetPrivate:function(){var b=this;$.post(Galaxy.root+"api/libraries/datasets/"+b.id+"/permissions?action=make_private").done(function(c){b.model.set({is_unrestricted:!1}),b.showPermissions({fetched_permissions:c}),a.success("The dataset is now private to you.")}).fail(function(){a.error("An error occurred while attempting to make dataset private.")})},removeDatasetRestrictions:function(){var b=this;$.post(Galaxy.root+"api/libraries/datasets/"+b.id+"/permissions?action=remove_restrictions").done(function(c){b.model.set({is_unrestricted:!0}),b.showPermissions({fetched_permissions:c}),a.success("Access to this dataset is now unrestricted.")}).fail(function(){a.error("An error occurred while attempting to make dataset unrestricted.")})},_extractIds:function(a){ids_list=[];for(var b=a.length-1;b>=0;b--)ids_list.push(a[b].id);return ids_list},savePermissions:function(){var b=this,c=this._extractIds(this.accessSelectObject.$el.select2("data")),d=this._extractIds(this.addSelectObject.$el.select2("data")),e=this._extractIds(this.manageSelectObject.$el.select2("data")),f=this._extractIds(this.modifySelectObject.$el.select2("data"));$.post(Galaxy.root+"api/libraries/"+b.id+"/permissions?action=set_permissions",{"access_ids[]":c,"add_ids[]":d,"manage_ids[]":e,"modify_ids[]":f}).done(function(c){b.showPermissions({fetched_permissions:c}),a.success("Permissions saved.")}).fail(function(){a.error("An error occurred while attempting to set library permissions.")})},templateLibrary:function(){var a=[];return a.push('<div class="library_style_container">'),a.push('  <div id="library_toolbar">'),a.push('   <button data-toggle="tooltip" data-placement="top" title="Modify library item" class="btn btn-default toolbtn_modify_dataset primary-button" type="button"><span class="fa fa-pencil"></span> Modify</span></button>'),a.push('   <a href="#folders/<%- item.get("folder_id") %>/datasets/<%- item.id %>/permissions"><button data-toggle="tooltip" data-placement="top" title="Manage permissions" class="btn btn-default toolbtn_change_permissions primary-button" type="button"><span class="fa fa-group"></span> Permissions</span></button></a>'),a.push('   <button data-toggle="tooltip" data-placement="top" title="Share dataset" class="btn btn-default toolbtn-share-dataset primary-button" type="button"><span class="fa fa-share"></span> Share</span></button>'),a.push("  </div>"),a.push("  <p>"),a.push("  This dataset is unrestricted so everybody can access it. Just share the URL of this page. "),a.push('  <button data-toggle="tooltip" data-placement="top" title="Copy to clipboard" class="btn btn-default btn-copy-link-to-clipboard primary-button" type="button"><span class="fa fa-clipboard"></span> To Clipboard</span></button> '),a.push("  </p>"),a.push('<div class="dataset_table">'),a.push('   <table class="grid table table-striped table-condensed">'),a.push("       <tr>"),a.push('           <th scope="row" id="id_row" data-id="<%= _.escape(item.get("ldda_id")) %>">Name</th>'),a.push('           <td><%= _.escape(item.get("name")) %></td>'),a.push("       </tr>"),a.push('   <% if (item.get("file_ext")) { %>'),a.push("       <tr>"),a.push('           <th scope="row">Data type</th>'),a.push('           <td><%= _.escape(item.get("file_ext")) %></td>'),a.push("       </tr>"),a.push("   <% } %>"),a.push("    </table>"),a.push("</div>"),a.push("</div>"),_.template(a.join(""))},templateLibraryPermissions:function(){var a=[];return a.push('<div class="library_style_container">'),a.push('  <div id="library_toolbar">'),a.push('   <a href="#"><button data-toggle="tooltip" data-placement="top" title="Go back to the list of Libraries" class="btn btn-default primary-button" type="button"><span class="fa fa-list"></span> Libraries</span></button></a>'),a.push("  </div>"),a.push('<h1>Library: <%= _.escape(library.get("name")) %></h1>'),a.push('<div class="alert alert-warning">'),a.push("<% if (is_admin) { %>"),a.push("You are logged in as an <strong>administrator</strong> therefore you can manage any library on this Galaxy instance. Please make sure you understand the consequences."),a.push("<% } else { %>"),a.push("You can assign any number of roles to any of the following permission types. However please read carefully the implications of such actions."),a.push("<% }%>"),a.push("</div>"),a.push('<div class="dataset_table">'),a.push("<h2>Library permissions</h2>"),a.push("<h4>Roles that can access the library</h4>"),a.push('<div id="access_perm" class="access_perm roles-selection"></div>'),a.push('<div class="alert alert-info roles-selection">User with <strong>any</strong> of these roles can access this library. If there are no access roles set on the library it is considered <strong>unrestricted</strong>.</div>'),a.push("<h4>Roles that can manage permissions on this library</h4>"),a.push('<div id="manage_perm" class="manage_perm roles-selection"></div>'),a.push('<div class="alert alert-info roles-selection">User with <strong>any</strong> of these roles can manage permissions on this library (includes giving access).</div>'),a.push("<h4>Roles that can add items to this library</h4>"),a.push('<div id="add_perm" class="add_perm roles-selection"></div>'),a.push('<div class="alert alert-info roles-selection">User with <strong>any</strong> of these roles can add items to this library (folders and datasets).</div>'),a.push("<h4>Roles that can modify this library</h4>"),a.push('<div id="modify_perm" class="modify_perm roles-selection"></div>'),a.push('<div class="alert alert-info roles-selection">User with <strong>any</strong> of these roles can modify this library (name, synopsis, etc.).</div>'),a.push('<button data-toggle="tooltip" data-placement="top" title="Save modifications made on this page" class="btn btn-default toolbtn_save_permissions primary-button" type="button"><span class="fa fa-floppy-o"></span> Save</span></button>'),a.push("</div>"),a.push("</div>"),_.template(a.join(""))}});return{LibraryView:d}});
//# sourceMappingURL=../../../maps/mvc/library/library-library-view.js.map