define("mvc/tag",["exports","mvc/base-mvc","utils/localization"],function(t,e,i){"use strict";function s(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(t,"__esModule",{value:!0});var a=s(e),n=s(i),o=Backbone.View.extend(a.default.LoggableMixin).extend(a.default.HiddenUntilActivatedViewMixin).extend({tagName:"div",className:"tags-display",select_width:"100%",events:{},initialize:function(t){this.show_editor=!1,!1===t.usePrompt?this.label="":this.label='<label class="prompt">'+(0,n.default)("Tags")+"</label>",this.workflow_mode=t.workflow_mode||!1,this.workflow_mode&&(this.events.click="showEditor",this.events.keydown="keydownHandler"),this.hiddenUntilActivated(t.$activator,t)},render:function(){var t=this;return this.workflow_mode?this.$el.html(this._workflowTemplate()):this.$el.html(this._defaultTemplate()),this.$input().select2({placeholder:"Add tags",width:this.workflow_mode?this.width:this.select_width,tags:function(){return t._getTagsUsed()}}),this._setUpBehaviors(),this},_hashToName:function(t){return t.startsWith("#")?"name:"+t.slice(1):t},_nameToHash:function(t){return t.startsWith("name:")&&(t="#"+t.slice(5)),t},_defaultTemplate:function(){return[this.label,this._renderEditor()].join("")},_workflowTemplate:function(){return[this.show_editor?this._renderEditor():this._renderTags()].join(" ")},keydownHandler:function(t){switch(t.which){case 27:this.hideEditor()}},showEditor:function(){this.show_editor=!0,this.render()},hideEditor:function(){this.show_editor=!1,this.render()},_renderEditor:function(){return'<input class="tags-input" value="'+this.tagsToCSV()+'"/>'},_renderTags:function(){var t=this.model.get("tags"),e=Galaxy.root+"static/images/fugue/tag--plus.png",i=[];return _.each(t,function(t){var e='<span class="badge badge-primary badge-tags">'+(t=0==t.indexOf("name:")?t.slice(5):t)+"</span>";i.push(e)}),0===i.length&&i.push("<img src="+e+' class="add-tag-button" title="Add tags"/>'),i.join(" ")},tagsToCSV:function(){var t=this,e=this.model.get("tags");return!_.isArray(e)||_.isEmpty(e)?"":e.map(function(e){return _.escape(t._nameToHash(e))}).sort().join(",")},$input:function(){return this.$el.find("input.tags-input")},_getTagsUsed:function(){var t=this;return _.map(Galaxy.user.get("tags_used"),t._nameToHash)},_setUpBehaviors:function(){var t=this;this.$input().on("change",function(e){e.val=_.map(e.val,t._hashToName),t.model.save({tags:e.val}),e.added&&t._addNewTagToTagsUsed(""+e.added.text)})},_addNewTagToTagsUsed:function(t){var e=Galaxy.user.get("tags_used");_.contains(e,t)||(e.push(t),e.sort(),Galaxy.user.set("tags_used",e))},remove:function(){this.$input.off(),this.stopListening(this.model),Backbone.View.prototype.remove.call(this)},toString:function(){return["TagsEditor(",""+this.model,")"].join("")}});t.default={TagsEditor:o}});