define("mvc/tool/tool-form-composite",["exports","utils/localization","utils/utils","utils/deferred","mvc/ui/ui-misc","mvc/form/form-view","mvc/form/form-data","mvc/tool/tool-form-base","mvc/ui/ui-modal","mvc/webhooks","mvc/workflow/workflow-icons"],function(e,t,s,a,i,o,r,n,l,p,u){"use strict";function d(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(e,"__esModule",{value:!0});var c=d(t),h=d(s),f=d(a),m=d(i),w=d(o),b=d(r),v=d(n),y=d(l),g=d(p),k=d(u),x=Backbone.View.extend({initialize:function(e){this.modal=parent.Galaxy.modal||new y.default.View,this.model=e&&e.model||new Backbone.Model(e),this.deferred=new f.default,e&&e.active_tab&&(this.active_tab=e.active_tab),this.setElement($("<div/>").addClass("ui-form-composite").append(this.$message=$("<div/>")).append(this.$header=$("<div/>")).append(this.$steps=$("<div/>"))),$("body").append(this.$el),this._configure(),this.render()},_configure:function(){function e(e,a){for(var i,o=/\$\{(.+?)\}/g;i=o.exec(String(e));){var r=i[1];a(t.wp_inputs[r]=t.wp_inputs[r]||{label:r,name:r,type:"text",color:"hsl( "+100*++s+", 70%, 30% )",style:"ui-form-wp-source",links:[]})}}var t=this;this.forms=[],this.steps=[],this.links=[],this.parms=[],_.each(this.model.get("steps"),function(e,s){Galaxy.emit.debug("tool-form-composite::initialize()",s+" : Preparing workflow step.");var a=k.default[e.step_type],i=parseInt(s+1)+": "+(e.step_label||e.step_name);e.annotation&&(i+=" - "+e.annotation),e.step_version&&(i+=" (Galaxy Version "+e.step_version+")"),e=h.default.merge({index:s,fixed_title:_.escape(i),icon:a||"",help:null,citations:null,collapsible:!0,collapsed:s>0&&!t._isDataStep(e),sustain_version:!0,sustain_repeats:!0,sustain_conditionals:!0,narrow:!0,text_enable:"Edit",text_disable:"Undo",cls_enable:"fa fa-edit",cls_disable:"fa fa-undo",errors:e.messages,initial_errors:!0,cls:"ui-portlet-narrow",hide_operations:!0,needs_refresh:!1,always_refresh:"tool"!=e.step_type},e),t.steps[s]=e,t.links[s]=[],t.parms[s]={}}),_.each(this.steps,function(e,s){b.default.visitInputs(e.inputs,function(e,a){t.parms[s][a]=e})}),_.each(this.steps,function(e,s){_.each(e.output_connections,function(e){_.each(t.steps,function(a,i){a.step_index===e.input_step_index&&t.links[s].push(a)})})}),_.each(this.steps,function(e,s){_.each(t.steps,function(a,i){var o={};_.each(e.output_connections,function(e){a.step_index===e.input_step_index&&(o[e.input_name]=e)}),_.each(t.parms[i],function(t,a){var i=o[a];i&&(t.type="hidden",t.help=t.step_linked?t.help+", ":"",t.help+="Output dataset '"+i.output_name+"' from step "+(parseInt(s)+1),t.step_linked=t.step_linked||[],t.step_linked.push({index:e.index,step_type:e.step_type}))})})});var s=0;this.wp_inputs={},_.each(this.steps,function(s,a){_.each(t.parms[a],function(t,a){e(t.value,function(e){e.links.push(s),t.wp_linked=!0,t.type="text",t.backdrop=!0,t.style="ui-form-wp-target"})}),_.each(s.post_job_actions,function(t){_.each(t.action_arguments,function(t){e(t,function(){})})})}),_.each(this.steps,function(e,s){if("tool"==e.step_type){var a=!0;b.default.visitInputs(e.inputs,function(s,i,o){var r=s.value&&"RuntimeValue"==s.value.__class__,n=-1!=["data","data_collection"].indexOf(s.type),l=o[s.data_ref];s.step_linked&&!t._isDataStep(s.step_linked)&&(a=!1),s.options&&(0==s.options.length&&!a||s.wp_linked)&&(s.is_workflow=!0),l&&(s.is_workflow=l.step_linked&&!t._isDataStep(l.step_linked)||s.wp_linked),(n||s.value&&"RuntimeValue"==s.value.__class__&&!s.step_linked)&&(e.collapsed=!1),r&&(s.value=s.default_value),s.flavor="workflow",r||n||"hidden"===s.type||s.wp_linked||(s.optional||!h.default.isEmpty(s.value)&&""!==s.value)&&(s.collapsible_value=s.value,s.collapsible_preview=!0)})}})},render:function(){var e=this;this.deferred.reset(),this._renderHeader(),this._renderMessage(),this._renderParameters(),this._renderHistory(),this._renderUseCachedJob(),this._renderResourceParameters(),_.each(this.steps,function(t){e._renderStep(t)})},_renderHeader:function(){var e=this;this.execute_btn=new m.default.Button({icon:"fa-check",title:(0,c.default)("Run workflow"),cls:"btn btn-primary",onclick:function(){e._execute()}}),this.$header.addClass("ui-form-header").empty().append(new m.default.Label({title:"Workflow: "+this.model.get("name")}).$el).append(this.execute_btn.$el)},_renderMessage:function(){this.$message.empty(),this.model.get("has_upgrade_messages")&&this.$message.append(new m.default.Message({message:"Some tools in this workflow may have changed since it was last saved or some errors were found. The workflow may still run, but any new options will have default values. Please review the messages below to make a decision about whether the changes will affect your analysis.",status:"warning",persistent:!0,fade:!1}).$el);var e=this.model.get("step_version_changes");e&&e.length>0&&this.$message.append(new m.default.Message({message:"Some tools are being executed with different versions compared to those available when this workflow was last saved because the other versions are not or no longer available on this Galaxy instance. To upgrade your workflow and dismiss this message simply edit the workflow and re-save it.",status:"warning",persistent:!0,fade:!1}).$el)},_renderParameters:function(){var e=this;this.wp_form=null,_.isEmpty(this.wp_inputs)||(this.wp_form=new w.default({title:"<b>Workflow Parameters</b>",inputs:this.wp_inputs,cls:"ui-portlet-narrow",onchange:function(){_.each(e.wp_form.input_list,function(t,s){_.each(t.links,function(t){e._refreshStep(t)})})}}),this._append(this.$steps.empty(),this.wp_form.$el))},_renderHistory:function(){this.history_form=new w.default({cls:"ui-portlet-narrow",title:"<b>History Options</b>",inputs:[{type:"conditional",name:"new_history",test_param:{name:"check",label:"Send results to a new history",type:"boolean",value:"false",help:""},cases:[{value:"true",inputs:[{name:"name",label:"History name",type:"text",value:this.model.get("name")}]}]}]}),this._append(this.$steps,this.history_form.$el)},_renderResourceParameters:function(){this.workflow_resource_parameters_form=null,_.isEmpty(this.model.get("workflow_resource_parameters"))||(this.workflow_resource_parameters_form=new w.default({cls:"ui-portlet-narrow",title:"<b>Workflow Resource Options</b>",inputs:this.model.get("workflow_resource_parameters")}),this._append(this.$steps,this.workflow_resource_parameters_form.$el))},_renderUseCachedJob:function(){var e={};Galaxy.user.attributes.preferences&&"extra_user_preferences"in Galaxy.user.attributes.preferences&&(e=JSON.parse(Galaxy.user.attributes.preferences.extra_user_preferences));var t="use_cached_job|use_cached_job_checkbox"in e&&e["use_cached_job|use_cached_job_checkbox"];this.display_use_cached_job_checkbox="true"===t,this.display_use_cached_job_checkbox&&(this.job_options_form=new w.default({cls:"ui-portlet-narrow",title:"<b>Job re-use Options</b>",inputs:[{type:"conditional",name:"use_cached_job",test_param:{name:"check",label:"BETA: Attempt to reuse jobs with identical parameters?",type:"boolean",value:"false",help:"This may skip executing jobs that you have already run."}}]}),this._append(this.$steps,this.job_options_form.$el))},_renderStep:function(e){var t=this,s=null;this.deferred.execute(function(a){if(t.$steps.addClass("ui-steps"),"tool"==e.step_type)e.postchange=function(t,s){var a={tool_id:e.id,tool_version:e.version,inputs:$.extend(!0,{},s.data.create())};s.wait(!0),Galaxy.emit.debug("tool-form-composite::postchange()","Sending current state.",a),h.default.request({type:"POST",url:Galaxy.root+"api/tools/"+e.id+"/build",data:a,success:function(e){s.update(e),s.wait(!1),Galaxy.emit.debug("tool-form-composite::postchange()","Received new model.",e),t.resolve()},error:function(e){Galaxy.emit.debug("tool-form-composite::postchange()","Refresh request failed.",e),t.reject()}})},s=new v.default(e),e.post_job_actions&&e.post_job_actions.length&&s.portlet.append($("<div/>").addClass("ui-form-element-disabled").append($("<div/>").addClass("ui-form-title").html("<b>Job Post Actions</b>")).append($("<div/>").addClass("ui-form-preview").html(_.reduce(e.post_job_actions,function(e,t){return e+" "+t.short_str},""))));else{var i=-1!=["data_input","data_collection_input"].indexOf(e.step_type);_.each(e.inputs,function(e){e.flavor="module",e.hide_label=i}),s=new w.default(h.default.merge({title:e.fixed_title,onchange:function(){_.each(t.links[e.index],function(e){t._refreshStep(e)})},inputs:e.inputs&&e.inputs.length>0?e.inputs:[{type:"hidden",name:"No options available.",ignore:null}]},e)),e.step_label&&s.$el.attr("step-label",e.step_label)}t.forms[e.index]=s,t._append(t.$steps,s.$el),e.needs_refresh&&t._refreshStep(e),s.portlet[t.show_progress?"disable":"enable"](),t.show_progress&&t.execute_btn.model.set({wait:!0,wait_text:"Preparing...",percentage:100*(e.index+1)/t.steps.length}),Galaxy.emit.debug("tool-form-composite::initialize()",e.index+" : Workflow step state ready.",e),setTimeout(function(){a.resolve()},0)})},_refreshStep:function(e){var t=this,s=this.forms[e.index];s?(_.each(t.parms[e.index],function(e,a){if(e.step_linked||e.wp_linked){var i=s.field_list[s.data.match(a)];if(i){var o=void 0;if(e.step_linked)o={values:[]},_.each(e.step_linked,function(e){if(t._isDataStep(e)){var s=t.forms[e.index].data.create().input;s&&_.each(s.values,function(e){o.values.push(e)})}}),!e.multiple&&o.values.length>0&&(o={values:[o.values[0]]});else if(e.wp_linked){o=e.value;for(var r,n=/\$\{(.+?)\}/g;r=n.exec(e.value);){var l=t.wp_form.field_list[t.wp_form.data.match(r[1])],p=l&&l.value();p&&(o=o.split(r[0]).join(p))}}void 0!==o&&i.value(o)}}}),s.trigger("change")):e.needs_refresh=!0},_refreshHistory:function(){var e=this,t=parent.Galaxy&&parent.Galaxy.currHistoryPanel&&parent.Galaxy.currHistoryPanel.model;this._refresh_history&&clearTimeout(this._refresh_history),t&&t.refresh().success(function(){0===t.numOfUnfinishedShownContents()&&(e._refresh_history=setTimeout(function(){e._refreshHistory()},t.UPDATE_DELAY))})},_execute:function(){var e=this;this.show_progress=!0,this._enabled(!1),this.deferred.execute(function(t){setTimeout(function(){t.resolve(),e._submit()},0)})},_submit:function(){var e=this,t=this.history_form.data.create(),s={new_history_name:t["new_history|name"]?t["new_history|name"]:null,history_id:t["new_history|name"]?null:this.model.get("history_id"),resource_params:this.workflow_resource_parameters_form?this.workflow_resource_parameters_form.data.create():{},replacement_params:this.wp_form?this.wp_form.data.create():{},parameters:{},parameters_normalized:!0,batch:!0};this.display_use_cached_job_checkbox&&(s.use_cached_job="true"===this.job_options_form.data.create()["use_cached_job|check"]);var a=!0;for(var i in this.forms){var o=this.forms[i],r=o.data.create(),n=e.steps[i],l=n.step_index;o.trigger("reset");for(var p in r){var u=r[p],d=o.data.match(p),_=(o.field_list[d],o.input_list[d]);if(!_.step_linked){if(!(a=this._isDataStep(n)?u&&u.values&&u.values.length>0:_.optional||_.is_workflow&&""!==u||!_.is_workflow&&null!==u)){o.highlight(d);break}s.parameters[l]=s.parameters[l]||{},s.parameters[l][p]=r[p]}}if(!a)break}a?(Galaxy.emit.debug("tool-form-composite::submit()","Validation complete.",s),h.default.request({type:"POST",url:Galaxy.root+"api/workflows/"+this.model.id+"/invocations",data:s,success:function(t){if(Galaxy.emit.debug("tool-form-composite::submit","Submission successful.",t),e.$el.children().hide(),e.$el.append(e._templateSuccess(t)),$.isArray(t)&&t.length>0){e.$el.append($("<div/>",{id:"webhook-view"}));new g.default.WebhookView({type:"workflow",toolId:s.tool_id,toolVersion:s.tool_version})}e._refreshHistory()},error:function(t){Galaxy.emit.debug("tool-form-composite::submit","Submission failed.",t);var a=!1;if(t&&t.err_data)for(var i in e.forms){var o=e.forms[i],r=t.err_data[o.model.get("step_index")];if(r){var n=o.data.matchResponse(r);for(var l in n){o.highlight(l,n[l]),a=!0;break}}}a||e.modal.show({title:(0,c.default)("Workflow submission failed"),body:e._templateError(s,t&&t.err_msg),buttons:{Close:function(){e.modal.hide()}}})},complete:function(){e._enabled(!0)}})):(e._enabled(!0),Galaxy.emit.debug("tool-form-composite::submit()","Validation failed.",s))},_append:function(e,t){e.append("<p/>").append(t)},_enabled:function(e){this.execute_btn.model.set({wait:!e,wait_text:"Sending...",percentage:-1}),this.wp_form&&this.wp_form.portlet[e?"enable":"disable"](),this.history_form&&this.history_form.portlet[e?"enable":"disable"](),_.each(this.forms,function(t){t&&t.portlet[e?"enable":"disable"]()})},_isDataStep:function(e){for(var t=$.isArray(e)?e:[e],s=0;s<t.length;s++){var a=t[s];if(!a||!a.step_type||!a.step_type.startsWith("data"))return!1}return!0},_templateSuccess:function(e){return $.isArray(e)&&e.length>0?$("<div/>").addClass("donemessagelarge").append($("<p/>").html("Successfully invoked workflow <b>"+h.default.sanitize(this.model.get("name"))+"</b>"+(e.length>1?" <b>"+e.length+" times</b>":"")+".")).append($("<p/>").append("<b/>").text("You can check the status of queued jobs and view the resulting data by refreshing the History pane. When the job has been run the status will change from 'running' to 'finished' if completed successfully or 'error' if problems were encountered.")):this._templateError(e,"Invalid success response. No invocations found.")},_templateError:function(e,t){return $("<div/>").addClass("errormessagelarge").append($("<p/>").text("The server could not complete the request. Please contact the Galaxy Team if this error persists. "+(JSON.stringify(t)||""))).append($("<pre/>").text(JSON.stringify(e,null,4)))}});e.default={View:x}});