define("mvc/dataset/dataset-choice",["exports","mvc/dataset/dataset-model","mvc/dataset/dataset-list","mvc/ui/ui-modal","mvc/base-mvc","utils/localization"],function(e,t,s,l,a,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function o(e,t,s){function l(e,t){for(var s in t)if(t.hasOwnProperty(s)&&e[s]!==t[s])return!1;return!0}return e.filter(function(e){return console.debug(e),!e.deleted&&e.visible&&(!s||void 0===e.collection_type)&&l(e,t)})}Object.defineProperty(e,"__esModule",{value:!0});var c=n(t),d=n(s),r=n(l),u=n(a),h=n(i),f=function(e,t){(t=_.defaults(t||{},{datasetsOnly:!0,where:{state:"ok"},multiselect:!1,selected:[]})).title=t.title||(t.multiselect?(0,h.default)("Choose datasets:"):(0,h.default)("Choose a dataset:"));var s,l,a,i=jQuery.Deferred();return(e=(t.filter||o)(e,t.where,t.datasetsOnly)).length?(t.multiselect&&((a={})[(0,h.default)("Ok")]=function(){i.resolve(l.getSelectedModels().map(function(e){return e.toJSON()}))}),(s=new r.default.View({height:"auto",buttons:a,closing_events:!0,closing_callback:function(){i.resolve(null)},body:['<div class="list-panel"></div>'].join("")})).$(".modal-header").remove(),s.$(".modal-footer").css("margin-top","0px"),(l=new d.default.DatasetList({title:t.title,subtitle:t.subtitle||(0,h.default)(["Click the checkboxes on the right to select datasets. ","Click the datasets names to see their details. "].join("")),el:s.$body.find(".list-panel"),selecting:!0,selected:t.selected,collection:new c.default.DatasetAssociationCollection(e)})).once("rendered:initial",function(){s.show(),s.$el.addClass("dataset-choice-modal")}),t.multiselect||(l.on("rendered",function(){l.$(".list-actions").hide()}),l.on("view:selected",function(e){i.resolve([e.model.toJSON()])})),l.render(0),i.always(function(){s.hide()})):i.reject("No matches found")},m=Backbone.View.extend(u.default.LoggableMixin).extend({_logNamespace:"dataset",className:"dataset-choice",initialize:function(e){this.debug(this+"(DatasetChoice).initialize:",e),this.label=void 0!==e.label?(0,h.default)(e.label):"",this.where=e.where,this.datasetsOnly=void 0===e.datasetsOnly||e.datasetsOnly,this.datasetJSON=e.datasetJSON||[],this.selected=e.selected||[],this._setUpListeners()},_setUpListeners:function(){},render:function(){var e=this.toJSON();return this.$el.html(this._template(e)),this.$(".selected").replaceWith(this._renderSelected(e)),this},_template:function(e){return _.template(["<label>",'<span class="prompt"><%- label %></span>','<div class="selected"></div>',"</label>"].join(""))(e)},_renderSelected:function(e){return e.selected.length?$(_.template(['<div class="selected">','<span class="title"><%- selected.hid %>: <%- selected.name %></span>','<span class="subtitle">',"<i><%- selected.misc_blurb %></i>","<i>",(0,h.default)("format")+": ","<%- selected.file_ext %></i>","<i><%- selected.misc_info %></i>","</span>","</div>"].join(""),{variable:"selected"})(e.selected[0])):$(['<span class="none-selected-msg">(',(0,h.default)("click to select a dataset"),")</span>"].join(""))},toJSON:function(){var e=this;return{label:e.label,datasets:e.datasetJSON,selected:_.compact(_.map(e.selected,function(t){return _.findWhere(e.datasetJSON,{id:t})}))}},events:{click:"chooseWithModal"},chooseWithModal:function(){var e=this;return this._createModal().done(function(t){t?(e.selected=_.pluck(t,"id"),e.trigger("selected",e,t),e.render()):e.trigger("cancelled",e)}).fail(function(){e.trigger("error",e,arguments)})},_createModal:function(){return new f(this.datasetJSON,this._getModalOptions())},_getModalOptions:function(){return{title:this.label,multiselect:!1,selected:this.selected,where:this.where,datasetsOnly:this.datasetsOnly}},toString:function(){return"DatasetChoice("+this.selected+")"}}),p=m.extend({className:m.prototype.className+" multi",cells:{hid:(0,h.default)("History #"),name:(0,h.default)("Name"),misc_blurb:(0,h.default)("Summary"),file_ext:(0,h.default)("Format"),genome_build:(0,h.default)("Genome"),tags:(0,h.default)("Tags"),annotation:(0,h.default)("Annotation")},initialize:function(e){this.showHeaders=void 0===e.showHeaders||e.showHeaders,this.cells=e.cells||this.cells,m.prototype.initialize.call(this,e)},_renderSelected:function(e){return e.selected.length?$(_.template(['<table class="selected">',"<% if( json.showHeaders ){ %>","<thead><tr>","<% _.map( json.cells, function( val, key ){ %>","<th><%- val %></th>","<% }); %>","</tr></thead>","<% } %>","<tbody>","<% _.map( json.selected, function( selected ){ %>","<tr>","<% _.map( json.cells, function( val, key ){ %>",'<td class="cell-<%- key %>"><%- selected[ key ] %></td>',"<% }) %>","</tr>","<% }); %>","</tbody>","</table>"].join(""),{variable:"json"})(e)):$(['<span class="none-selected-msg">(',(0,h.default)("click to select a dataset"),")</span>"].join(""))},toJSON:function(){return _.extend(m.prototype.toJSON.call(this),{showHeaders:this.showHeaders,cells:this.cells})},_getModalOptions:function(){return _.extend(m.prototype._getModalOptions.call(this),{multiselect:!0})},toString:function(){return"DatasetChoice("+this.selected+")"}});e.default={DatasetChoiceModal:f,DatasetChoice:m,MultiDatasetChoice:p}});