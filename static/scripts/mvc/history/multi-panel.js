define("mvc/history/multi-panel",["exports","utils/localization","libs/underscore","libs/backbone","mvc/history/history-model","mvc/history/history-view-edit","mvc/history/job-states-model","mvc/history/copy-dialog","mvc/ui/error-modal","mvc/base-mvc","utils/ajax-queue","ui/search-input"],function(e,t,n,i,o,r,s,l,a,c,d){"use strict";function u(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function h(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(e,"__esModule",{value:!0});var f=h(t),p=u(n),m=u(i),g=h(o),v=h(r),y=h(s),w=h(l),C=h(a),b=h(c),x=h(d),_=m.View.extend(b.default.LoggableMixin).extend({_logNamespace:"history",tagName:"div",className:"history-column flex-column flex-row-container",id:function(){return this.model?"history-column-"+this.model.get("id"):""},initialize:function(e){e=e||{},this.purgeAllowed=!p.isUndefined(e.purgeAllowed)&&e.purgeAllowed,this.panel=e.panel||this.createPanel(e),this.setUpListeners()},createPanel:function(e){return new v.default.HistoryViewEdit(p.defaults(e,{model:this.model,purgeAllowed:this.purgeAllowed,dragItems:!0,$scrollContainer:function(){return this.$el}}))},setUpListeners:function(){var e=this;this.once("rendered",function(){e.trigger("rendered:initial",e)}),this.setUpPanelListeners()},setUpPanelListeners:function(){var e=this;this.listenTo(this.panel,{rendered:function(){e.trigger("rendered",e)},"view:expanded view:rendered":function(e){e.$(".rerun-btn").off()}},this)},inView:function(e,t){var n=this.$el.offset().left;return!(n+this.$el.width()<e)&&!(n>t)},$panel:function(){return this.$(".history-panel")},render:function(e){e=void 0!==e?e:"fast";var t=this.model?this.model.toJSON():{};return this.$el.html(this.template(t)),this.renderPanel(e),this.panel.$el.css("display","flex"),this.setUpBehaviors(),this},setUpBehaviors:function(){},template:function(e){return e=p.extend(e||{},{isCurrentHistory:this.currentHistory}),$('\n            <div class="panel-controls mb-1">\n                <div class="flex-row flex-column-container no-gutters justify-content-between">\n                    '+this.controlsLeftTemplate({history:e,view:this})+"\n                    "+this.controlsRightTemplate({history:e,view:this})+'\n                </div>\n            </div>\n            <div class="inner flex-row flex-column-container">\n                <div id="history-'+e.id+'" class="history-column history-panel flex-column"></div>\n            </div>')},renderPanel:function(e){return e=void 0!==e?e:"fast",this.panel.setElement(this.$panel()).render(e),this.currentHistory&&this.panel.$list().before(this.panel._renderDropTargetHelp()),this},events:{"click .switch-to.btn":function(){this.model.setAsCurrent()},"click .delete-history":function(){var e=this;this.model._delete().done(function(t){e.render()})},"click .undelete-history":function(){var e=this;this.model.undelete().done(function(t){e.render()})},"click .purge-history":function(){var e=this;window.confirm((0,f.default)("This will permanently remove the data. Are you sure?"))&&this.model.purge().done(function(t){e.render()})},"click .copy-history":"copy"},copy:function(){(0,w.default)(this.model)},controlsLeftTemplate:p.template('\n        <div class="text-left col-8">\n            <% if( data.history.isCurrentHistory ){ %>\n                <strong class="current-label">\n                    '+(0,f.default)("Current History")+'\n                </strong>\n            <% } else { %>\n                <button class="switch-to btn btn-secondary">\n                    '+(0,f.default)("Switch to")+"\n                </button>\n            <% } %>\n        </div>",{variable:"data"}),controlsRightTemplate:p.template('<div class="text-right col-4">\n            <% if( !data.history.purged ){ %>\n                <div class="panel-menu btn-group">\n                    <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">\n                        <span class="caret"></span>\n                    </button>\n                    <ul class="dropdown-menu" role="menu">\n                        <% if( !data.history.deleted ){ %>\n                            <li><a href="javascript:void(0);" class="copy-history">\n                                '+(0,f.default)("Copy")+'\n                            </a></li>\n                            <li><a href="javascript:void(0);" class="delete-history">\n                                '+(0,f.default)("Delete")+'\n                            </a></li>\n                        <% } else /* if is deleted */ { %>\n                            <li><a href="javascript:void(0);" class="undelete-history">\n                                '+(0,f.default)("Undelete")+'\n                            </a></li>\n                        <% } %>\n                        <% if( data.view.purgeAllowed ){ %>\n                            <li><a href="javascript:void(0);" class="purge-history">\n                                '+(0,f.default)("Purge")+"\n                            </a></li>\n                        <% } %>\n                    </ul>\n                </div>\n            <% } %>\n        </div>",{variable:"data"}),toString:function(){return"HistoryViewColumn("+(this.panel?this.panel:"")+")"}}),H=m.View.extend(b.default.LoggableMixin).extend({_logNamespace:"history",className:"multi-panel-history",initialize:function(e){e=e||{},this.log(this+".init",e),this.$el.addClass(this.className),this.options={columnWidth:312,borderWidth:1,columnGap:8,headerHeight:29,footerHeight:0,controlsHeight:20},this.perPage=e.perPage||10,this.hdaQueue=new x.default.NamedAjaxQueue([],!1),this.collection=null,this.columnMap={},this.columnOptions=e.columnOptions||{},this.historySearch=null,this.datasetSearch=null,this.setCollection(e.histories),this.setUpListeners()},setUpListeners:function(){var e=this;this.on("end-of-scroll",function(){e.collection.fetchMore()})},setCollection:function(e){return this.stopListening(this.collection),this.collection=e||new g.default.HistoryCollection,this.setUpCollectionListeners(),this.createColumns(),this.hdaQueue.clear(),this.trigger("new-collection",this),this},addModels:function(e,t,n){var i=this;return n=n||{},(e=p.isArray(e)?e:[e]).forEach(function(e){i.addColumn(e,!1)}),this},setUpCollectionListeners:function(){this.listenTo(this.collection,{error:this.errorHandler,add:this.addModels,"all-fetched":this._postFetchAll,"new-current":this.addAsCurrentColumn,"set-as-current":this.setCurrentHistory,"change:deleted change:purged":this.handleDeletedHistory,sort:function(){this.renderColumns(0)}})},_postFetchAll:function(e){if(this.$(".histories-loading-indicator").remove(),!this.historySearch){var t=this.$(".outer-middle");t.scrollLeft(t.scrollLeft()+24)}},setCurrentHistory:function(e){this.log("setCurrentHistory:",e);var t=p.findWhere(this.columnMap,{currentHistory:!0});t&&(t.currentHistory=!1,t.$el.height(""));var n=this.columnMap[this.collection.currentHistoryId];return n.currentHistory=!0,this.collection.sort(),this._recalcFirstColumnHeight(),n},handleDeletedHistory:function(e){if(e.get("deleted")||e.get("purged")){this.log("handleDeletedHistory",this.collection.includeDeleted,e);var t=this.columnMap[e.id];if(!t)return;t.model.id===this.collection.currentHistoryId||this.collection.includeDeleted||this.removeColumn(t)}},errorHandler:function(e,t,n){if(!t||0!==t.status||0!==t.readyState){if(this.error(e,t,n),p.isString(e)&&p.isString(t)){var i=e,o=t;return C.default.errorModal(i,o,n)}return t&&502===t.status?C.default.badGatewayErrorModal():C.default.ajaxErrorModal(e,t,n)}},_ajaxErrorHandler:function(){C.default.ajaxErrorModal.apply(null,p.toArray(arguments))},create:function(e){return this.collection.create({current:!0})},createColumns:function(e,t){var n=this;t=t||this.options.columnOptions,this.columnMap={},this.collection.each(function(e,i){n.columnMap[e.id]=n.createColumn(e,t)})},createColumn:function(e,t){t=p.extend({},t,{model:e,purgeAllowed:Galaxy.config.allow_user_dataset_purge});var n=new _(t);return e.id===this.collection.currentHistoryId&&(n.currentHistory=!0),this.setUpColumnListeners(n),this.datasetSearch&&(n.panel.searchItems(this.datasetSearch),this.queueHdaFetchDetails(n)),n},addColumn:function(e,t){t=void 0===t||t;var n=this.createColumn(e);return this.columnMap[e.id]=n,t&&this.renderColumns(),n},addAsCurrentColumn:function(e,t,n){var i=this,o=this.addColumn(e,!1);return this.setCurrentHistory(e),o.once("rendered",function(){i.queueHdaFetch(o)}),o},removeColumn:function(e,t){var n=this;if(t=void 0===t||t,this.log("removeColumn",e),e){var i=this.options.columnWidth+this.options.columnGap;e.$el.fadeOut("fast",function(){t&&($(n).remove(),n.$(".middle").width(n.$(".middle").width()-i),n.checkColumnsInView(),n._recalcFirstColumnHeight()),n.stopListening(e.panel),n.stopListening(e),delete n.columnMap[e.model.id],e.remove()})}},setUpColumnListeners:function(e){var t=this;this.listenTo(e,{"in-view":this.queueHdaFetch}),this.listenTo(e.panel,{"view:draggable:dragstart":function(e,n,i,o){t._dropData=JSON.parse(e.dataTransfer.getData("text")),t.currentColumnDropTargetOn()},"view:draggable:dragend":function(e,n,i,o){t._dropData=null,t.currentColumnDropTargetOff()},"droptarget:drop":function(e,n,i){var o=t._dropData.filter(function(e){return i.model.contents.isCopyable(e)});t._dropData=null;var r=new x.default.NamedAjaxQueue;0!==i.model.contents.currentPage&&r.add({name:"fetch-front-page",fn:function(){return i.model.contents.fetchPage(0)}}),o.reverse().forEach(function(e){r.add({name:"copy-"+e.id,fn:function(){return i.model.contents.copy(e)}})}),r.start(),r.done(function(e){i.model.fetch()})}})},columnMapLength:function(){return Object.keys(this.columnMap).length},sortedFilteredColumns:function(e){return(e=e||this.filters)&&e.length?this.sortedColumns().filter(function(t,n){return t.currentHistory||p.every(e.map(function(e){return e.call(t)}))}):this.sortedColumns()},sortedColumns:function(){var e=this;return this.collection.map(function(t,n){return e.columnMap[t.id]})},render:function(e){return e=void 0!==e?e:this.fxSpeed,this.log(this+".render"),this.$el.html(this.mainTemplate),this.renderColumns(e),this.setUpBehaviors(),this.trigger("rendered",this),this},renderColumns:function(e){e=p.isNumber(e)?e:this.fxSpeed;var t=this.sortedFilteredColumns(),n=this.$(".middle").empty();return this._addColumns(t,e),this.collection.allFetched||n.append(this.loadingIndicatorTemplate),this.trigger("columns-rendered",t,this),(!this.datasetSearch||t.length>1)&&(this.checkColumnsInView(),this._recalcFirstColumnHeight()),t},_addColumns:function(e,t){t=p.isNumber(t)?t:this.fxSpeed;var n=this.$(".middle"),i=n.children(".history-column").length;n.width(this._calcMiddleWidth(e.length+i)),e.forEach(function(e,i){e.delegateEvents().render(t).$el.appendTo(n)})},_calcMiddleWidth:function(e){return e*(this.options.columnWidth+this.options.columnGap)+this.options.columnGap+16},queueHdaFetch:function(e){var t=e.model.contents;if(0===t.length&&e.model.contentsShown()){var n={silent:!0},i=p.values(t.storage.allExpanded()).join();i&&(n.details=i),this.hdaQueue.add({name:e.model.id,fn:function(){return t.fetchCurrentPage(n).done(function(){e.panel.renderItems()}).done(function(){y.default.FETCH_STATE_ON_ADD||t.jobStateSummariesCollection.fetch()})}}),this.hdaQueue.running||this.hdaQueue.start()}},queueHdaFetchDetails:function(e){var t=e.model.contents;!(0===t.length&&e.model.contentsShown())&&t.haveDetails()||(this.hdaQueue.add({name:e.model.id,fn:function(){return t.progressivelyFetchDetails().done(function(){e.panel._renderEmptyMessage()})}}),this.hdaQueue.running||this.hdaQueue.start())},renderInfo:function(e){return this.$(".header .header-info").text(e)},events:{"click .done.btn":"close","click .create-new.btn":"create","click #include-deleted":"_clickToggleDeletedHistories","click .order .set-order":"_chooseOrder","click #toggle-deleted":"_clickToggleDeletedDatasets","click #toggle-hidden":"_clickToggleHiddenDatasets"},close:function(e){window.location=Galaxy.root},_clickToggleDeletedHistories:function(e){this.toggleDeletedHistories($(e.currentTarget).is(":checked")),this.toggleOptionsPopover()},toggleDeletedHistories:function(e){window.location=e?Galaxy.root+"history/view_multiple?include_deleted_histories=True":Galaxy.root+"history/view_multiple"},_clickToggleDeletedDatasets:function(e){this.toggleDeletedDatasets($(e.currentTarget).is(":checked")),this.toggleOptionsPopover()},toggleDeletedDatasets:function(e){e=void 0!==e&&e,this.sortedFilteredColumns().forEach(function(t,n){p.delay(function(){t.panel.toggleShowDeleted(e,!1)},200*n)})},_clickToggleHiddenDatasets:function(e){this.toggleHiddenDatasets($(e.currentTarget).is(":checked")),this.toggleOptionsPopover()},toggleHiddenDatasets:function(e){e=void 0!==e&&e,this.sortedFilteredColumns().forEach(function(t,n){p.delay(function(){t.panel.toggleShowHidden(e,!1)},200*n)})},_chooseOrder:function(e){var t=this,n=this.collection,i=$(e.currentTarget).data("order");this.$(".current-order").text(this.orderDescriptions[i]),this.toggleOptionsPopover(),n.setOrder(i);var o=n.slice(0,1);n.fetchFirst().done(function(){n.unshift(o,{silent:!0}),t.createColumns(),t.hdaQueue.clear(),t.render()}),this.once("columns-rendered",this._scrollLeft)},_scrollLeft:function(e){e=p.isNumber(e)?e:0,this.$(".outer-middle").scrollLeft(e)},setUpBehaviors:function(){var e=this;this._moreOptionsPopover(),this.$("#search-histories").searchInput({name:"search-histories",placeholder:(0,f.default)("search histories"),onfirstsearch:function(t){e.$("#search-histories").searchInput("toggle-loading"),e.renderInfo((0,f.default)("loading all histories for search")),e.collection.fetchAll().done(function(){e.$("#search-histories").searchInput("toggle-loading"),e.renderInfo("")})},onsearch:function(t){e.historySearch=t,e.filters=[function(){return e.model.matchesAll(e.historySearch)}],e.renderColumns(0)},onclear:function(t){e.historySearch=null,e.filters=[],e.renderColumns(0)}}),this.$("#search-datasets").searchInput({name:"search-datasets",placeholder:(0,f.default)("search all datasets"),onfirstsearch:function(t){e.hdaQueue.clear(),e.$("#search-datasets").searchInput("toggle-loading"),e.datasetSearch=t,e.sortedFilteredColumns().forEach(function(n){n.panel.searchItems(t),e.queueHdaFetchDetails(n)}),e.hdaQueue.progress(function(t){e.renderInfo([(0,f.default)("searching"),t.curr+1,(0,f.default)("of"),t.total].join(" "))}),e.hdaQueue.deferred.done(function(){e.renderInfo(""),e.$("#search-datasets").searchInput("toggle-loading")})},onsearch:function(t){e.datasetSearch=t,e.sortedFilteredColumns().forEach(function(e){e.panel.searchItems(t)})},onclear:function(t){e.datasetSearch=null,e.sortedFilteredColumns().forEach(function(e){e.panel.clearSearch()})}}),$(window).resize(function(){e._recalcFirstColumnHeight()});var t=p.debounce(function(){var t=e._viewport();e.checkColumnsInView(t),e.checkForEndOfScroll(t)},100);this.$(".middle").parent().scroll(t)},_moreOptionsPopover:function(){return this.$(".open-more-options.btn").popover({container:".header",placement:"bottom",html:!0,content:$(this.optionsPopoverTemplate(this))})},toggleOptionsPopover:function(e){this.$(".open-more-options.btn").popover("toggle")},_recalcFirstColumnHeight:function(){var e=this.$(".history-column").first(),t=this.$(".middle").height(),n=e.find(".panel-controls").height();e.height(t).find(".inner").height(t-n)},_viewport:function(){var e=this.$(".middle").parent(),t=e.offset().left;return{left:t,right:t+e.width()}},columnsInView:function(e){var t=e||this._viewport();return this.sortedFilteredColumns().filter(function(e){return e.currentHistory||e.inView(t.left,t.right)})},checkColumnsInView:function(){this.columnsInView().forEach(function(e){e.trigger("in-view",e)})},checkForEndOfScroll:function(e){e=e||this._viewport();var t=this.$(".middle");t.parent().scrollLeft()+e.right>=t.width()-16&&this.trigger("end-of-scroll")},currentColumnDropTargetOn:function(){var e=this.columnMap[this.collection.currentHistoryId];e&&(e.panel.dataDropped=function(e){},e.panel.dropTargetOn())},currentColumnDropTargetOff:function(){var e=this.columnMap[this.collection.currentHistoryId];e&&(e.panel.dataDropped=v.default.HistoryViewEdit.prototype.dataDrop,e.panel.dropTarget=!1,e.panel.$(".history-drop-target").remove())},toString:function(){return"MultiPanelColumns("+(this.columns?this.columns.length:0)+")"},mainTemplate:'\n        <div class="header flex-column-container">\n            <div class="control-column control-column-left flex-column">\n                <div id="search-histories" class="search-control"></div>\n                <div id="search-datasets" class="search-control"></div>\n                <a class="open-more-options btn btn-secondary" tabindex="3">\n                    <span class="fa fa-ellipsis-h"></span>\n                </a>\n            </div>\n            <div class="control-column control-column-center flex-column">\n                <div class="header-info">\n                </div>\n            </div>\n            <div class="control-column control-column-right flex-column">\n                <button class="create-new btn btn-secondary" tabindex="4">\n                    '+(0,f.default)("Create new")+'\n                </button>\n            </div>\n        </div>\n        <div class="outer-middle flex-row flex-row-container">\n            <div class="middle flex-column-container flex-row"></div>\n        </div>\n        <div class="footer flex-column-container"></div>',loadingIndicatorTemplate:'\n        <div class="histories-loading-indicator">\n            <span class="fa fa-spin fa-spinner"></span>\n            '+(0,f.default)("Loading histories")+" ...\n        </div>",orderDescriptions:{update_time:(0,f.default)("most recent first"),"update_time-asc":(0,f.default)("least recent first"),name:(0,f.default)("name, a to z"),"name-dsc":(0,f.default)("name, z to a"),size:(0,f.default)("size, large to small"),"size-asc":(0,f.default)("size, small to large")},optionsPopoverTemplate:p.template(['<div class="more-options d-flex flex-column">','<div class="order btn-group mb-2">','<button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">',(0,f.default)("Order histories by")+" ",'<span class="current-order"><%- view.orderDescriptions[ view.collection.order ] %></span> ','<span class="caret"></span>',"</button>",'<ul class="dropdown-menu" role="menu">',"<% _.each( view.orderDescriptions, function( text, order ){ %>",'<li class="dropdown-item"><a href="javascript:void(0);" class="set-order" data-order="<%- order %>">',"<%- text %>","</a></li>","<% }); %>","</ul>","</div>",'<div class="checkbox"><label><input id="include-deleted" type="checkbox"','<%= view.collection.includeDeleted? " checked" : "" %>>',(0,f.default)("Include deleted histories"),"</label></div>",'<div class="checkbox"><label><input id="toggle-deleted" type="checkbox">',(0,f.default)("Include deleted datasets"),"</label></div>",'<div class="checkbox"><label><input id="toggle-hidden" type="checkbox">',(0,f.default)("Include hidden datasets"),"</label></div>","</div>"].join(""),{variable:"view"})});e.default={MultiPanelColumns:H}});