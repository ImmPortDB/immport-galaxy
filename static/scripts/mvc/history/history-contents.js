define("mvc/history/history-contents",["exports","mvc/base/controlled-fetch-collection","mvc/history/hda-model","mvc/history/hdca-model","mvc/history/history-preferences","mvc/history/job-states-model","mvc/base-mvc","utils/ajax-queue","libs/underscore","libs/backbone"],function(t,e,i,n,r,o,s,a,l,d){"use strict";function c(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}function u(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(t,"__esModule",{value:!0});var h=u(e),f=u(i),y=u(n),m=u(r),g=u(o),p=u(s),v=u(a),b=c(l),_=c(d),S=window.localStorage.getItem("historyContentsLimitPerPageDefault")||500,j=h.default.PaginatedCollection,D=j.extend(p.default.LoggableMixin).extend({_logNamespace:"history",limitPerPage:S,limitPerProgressiveFetch:S,order:"hid",urlRoot:Galaxy.root+"api/histories",url:function(){return this.urlRoot+"/"+this.historyId+"/contents"},initialize:function(t,e){this.on({"sync add":this.trackJobStates}),e=e||{},j.prototype.initialize.call(this,t,e),this.history=e.history||null,this.setHistoryId(e.historyId||null),this.includeDeleted=e.includeDeleted||this.includeDeleted,this.includeHidden=e.includeHidden||this.includeHidden,this.model.prototype.idAttribute="type_id"},trackJobStates:function(){var t=this;this.each(function(e){if(!e.has("job_states_summary")&&"dataset_collection"===e.attributes.history_content_type){var i=e.attributes.job_source_type,n=e.attributes.job_source_id;if(i&&t.jobStateSummariesCollection){t.jobStateSummariesCollection.add({id:n,model:i,history_id:t.history_id,collection_id:e.attributes.id});var r=t.jobStateSummariesCollection.get(n);e.jobStatesSummary=r}}})},model:function(t,e){return"dataset"===t.history_content_type?new f.default.HistoryDatasetAssociation(t,e):"dataset_collection"===t.history_content_type?new y.default.HistoryDatasetCollection(t,e):{validationError:"Unknown history_content_type: "+t.history_content_type}},stopPolling:function(){this.jobStateSummariesCollection&&(this.jobStateSummariesCollection.active=!1,this.jobStateSummariesCollection.clearUpdateTimeout())},setHistoryId:function(t){this.stopPolling(),this.historyId=t,t&&(this._setUpWebStorage(),this.jobStateSummariesCollection=new g.default.JobStatesSummaryCollection,this.jobStateSummariesCollection.historyId=t,this.jobStateSummariesCollection.monitor())},_setUpWebStorage:function(t){return this.storage=new m.default.HistoryPrefs({id:m.default.HistoryPrefs.historyStorageKey(this.historyId)}),this.trigger("new-storage",this.storage,this),this.on({"include-deleted":function(t){this.storage.includeDeleted(t)},"include-hidden":function(t){this.storage.includeHidden(t)}}),this.includeDeleted=this.storage.includeDeleted()||!1,this.includeHidden=this.storage.includeHidden()||!1,this},comparators:b.extend(b.clone(j.prototype.comparators),{name:p.default.buildComparator("name",{ascending:!0}),"name-dsc":p.default.buildComparator("name",{ascending:!1}),hid:p.default.buildComparator("hid",{ascending:!1}),"hid-asc":p.default.buildComparator("hid",{ascending:!0})}),running:function(){return this.filter(function(t){return!t.inReadyState()})},runningAndActive:function(){return this.filter(function(t){return!t.inReadyState()&&t.get("visible")&&!t.get("deleted")})},getByHid:function(t){return this.findWhere({hid:t})},haveDetails:function(){return this.all(function(t){return t.hasDetails()})},hidden:function(){return this.filter(function(t){return t.hidden()})},deleted:function(){return this.filter(function(t){return t.get("deleted")})},visibleAndUndeleted:function(){return this.filter(function(t){return t.get("visible")&&!t.get("deleted")})},setIncludeDeleted:function(t,e){if(b.isBoolean(t)&&t!==this.includeDeleted){if(this.includeDeleted=t,b.result(e,"silent"))return;this.trigger("include-deleted",t,this)}},setIncludeHidden:function(t,e){if(b.isBoolean(t)&&t!==this.includeHidden){if(this.includeHidden=t,e=e||{},b.result(e,"silent"))return;this.trigger("include-hidden",t,this)}},fetch:function(t){if(t=t||{},this.historyId&&!t.details){var e=m.default.HistoryPrefs.get(this.historyId).toJSON();b.isEmpty(e.expandedIds)||(t.details=b.values(e.expandedIds).join(","))}return j.prototype.fetch.call(this,t)},_buildFetchData:function(t){return b.extend(j.prototype._buildFetchData.call(this,t),{v:"dev"})},_fetchParams:j.prototype._fetchParams.concat(["v","details"]),_buildFetchFilters:function(t){var e=j.prototype._buildFetchFilters.call(this,t)||{},i={};return this.includeDeleted||(i.deleted=!1,i.purged=!1),this.includeHidden||(i.visible=!0),b.defaults(e,i)},getTotalItemCount:function(){return this.history.contentsShown()},fetchUpdated:function(t,e){return t&&((e=e||{filters:{}}).remove=!1,e.filters={"update_time-ge":t.toISOString(),visible:""}),this.fetch(e)},fetchDeleted:function(t){var e=this;return t=t||{},t.filters=b.extend(t.filters,{deleted:!0,purged:void 0}),t.remove=!1,this.trigger("fetching-deleted",this),this.fetch(t).always(function(){e.trigger("fetching-deleted-done",e)})},fetchHidden:function(t){var e=this;return t=t||{},t.filters=b.extend(t.filters,{visible:!1}),t.remove=!1,this.trigger("fetching-hidden",this),this.fetch(t).always(function(){e.trigger("fetching-hidden-done",e)})},fetchAllDetails:function(t){var e={details:"all"};return(t=t||{}).data=b.extend(t.data||{},e),this.fetch(t)},_filterAndUpdate:function(t,e){var i=this,n=this.model.prototype.idAttribute,r=[e];return this.fetch({filters:t,remove:!1}).then(function(t){return t=t.reduce(function(t,e,r){var o=i.get(e[n]);return o?t.concat(o):t},[]),i.ajaxQueue("save",r,t)})},ajaxQueue:function(t,e,i){return i=i||this.models,new v.default.AjaxQueue(i.slice().reverse().map(function(i,n){var r=b.isString(t)?i[t]:t;return function(){return r.apply(i,e)}})).deferred},_recursivelyFetch:function(t,e,i,n,r){var o=this;r=r||0;var s=b.extend(b.clone(t),{view:"summary",keys:e,limit:n,offset:r,reset:0===r,remove:!1});b.defer(function(){o.fetch.call(o,s).fail(i.reject).done(function(s){i.notify(s,n,r),s.length!==n?(o.allFetched=!0,i.resolve(s,n,r)):o._recursivelyFetch(t,e,i,n,r+n)})})},progressivelyFetchDetails:function(t){t=t||{};var e=jQuery.Deferred();return this._recursivelyFetch(t,f.default.HistoryDatasetAssociation.prototype.searchAttributes.join(","),e,t.limitPerCall||this.limitPerProgressiveFetch),e},isCopyable:function(t){var e=["HistoryDatasetAssociation","HistoryDatasetCollectionAssociation"];return b.isObject(t)&&t.id&&b.contains(e,t.model_class)},copy:function(t){var e,i,n;b.isString(t)?(e=t,n="hda",i="dataset"):(e=t.id,n={HistoryDatasetAssociation:"hda",LibraryDatasetDatasetAssociation:"ldda",HistoryDatasetCollectionAssociation:"hdca"}[t.model_class]||"hda",i="hdca"===n?"dataset_collection":"dataset");var r=this,o=jQuery.ajax(this.url(),{method:"POST",contentType:"application/json",data:JSON.stringify({content:e,source:n,type:i})}).done(function(t){r.add([t],{parse:!0})}).fail(function(t,s,a){r.trigger("error",r,o,{},"Error copying contents",{type:i,id:e,source:n})});return o},createHDCA:function(t,e,i,n,r){return this.model({history_content_type:"dataset_collection",collection_type:e,history_id:this.historyId,name:i,hide_source_items:n||!1,element_identifiers:t}).save(r)},haveSearchDetails:function(){return this.allFetched&&this.all(function(t){return b.has(t.attributes,"annotation")})},matches:function(t){return this.filter(function(e){return e.matches(t)})},clone:function(){var t=_.Collection.prototype.clone.call(this);return t.historyId=this.historyId,t},toString:function(){return["HistoryContents(",[this.historyId,this.length].join(),")"].join("")}});t.default={HistoryContents:D}});