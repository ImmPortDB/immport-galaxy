var scatterData2D = {};
var scatterData3D = {};
var scatterData3DMFI = {};

var waitForFinalEvent = (function () {
  var timers = {};
  return function (callback, ms, uniqueId) {
    if (!uniqueId) {
      uniqueId = "Don't call this twice without a uniqueId";
    }
    if (timers[uniqueId]) {
      clearTimeout (timers[uniqueId]);
    }
    timers[uniqueId] = setTimeout(callback, ms);
  };
})();


var updateMFIDisplay = function(data) {
    $('#mfiDiv').empty();
    var table = $("<table/>");
    $.each(data, function(rowIndex,r) {
        var row = $("<tr/>");
        $.each(r,function(colIndex,c) {
            row.append($("<t"+(rowIndex ==0 ? "h" : "d")+" align='right'/>").text(c));
        });
        table.append(row);

    });
    $('#mfiDiv').html(table);
}

//var updatePopDisplay = function(data) {
//    $('#popDiv').empty();
//    $('#popDiv').html("<pre>" + data + "</pre>");
//}

var updateOverviewPlotDisplay = function(data) {
    $('#overviewPlotDiv').empty();
    $('#overviewPlotDiv').html(data);
}

var updateScatterDisplay2D = function(scatterData2D) {
    $('#scatterPlotDiv2D').empty();
    $("#xAxisMarker2D").select2();
    $("#yAxisMarker2D").select2();

    $("#xAxisMarker2D").on("change",function(e) {
        var m1 = $("#xAxisMarker2D").select2("val");
        scatterData2D['m1'] = m1;
    });
    $("#yAxisMarker2D").on("change",function(e) {
        var m2 = $("#yAxisMarker2D").select2("val");
        scatterData2D['m2'] = m2;
    });

    $("#updateDisplay2D").on("click",function() {
        scatterData2D['populations'] = [];
        $('.pop2D').each(function() {
            if (this.checked) {
                scatterData2D['populations'].push(parseInt(this.value));
            }
        });
        processScatterData2D(scatterData2D);
        displayScatterPlot2D('#scatterPlotDiv2D',scatterData2D);
    });

    $('#selectall2D').click(function() {
        var checkAll = $("#selectall2D").prop('checked');
        if (checkAll) {
            $(".pop2D").prop("checked", true);
        } else {
            $(".pop2D").prop("checked", false);
        }
    });
    $('.pop2D').click(function() {
        if ($('.pop2D').length == $(".pop2D:checked").length) {
            $('#selectall2D').prop("checked",true);
        } else {
            $('#selectall2D').prop("checked",false);
        }
    });

    processScatterData2D(scatterData2D);
    displayToolbar2D('#toolbarDiv2D','#populationDiv2D',scatterData2D);
    displayScatterPlot2D('#scatterPlotDiv2D',scatterData2D);
    $(window).on('resize',function() {
        waitForFinalEvent(function() {
            processScatterData2D(scatterData2D);
            displayScatterPlot2D('#scatterPlotDiv2D',scatterData2D);
        },500,"resize2D");
    });
}


var displayMFI = function() {
    var url = "flow.mfi_pop";
    $.ajax({
       url: url,
       dataType: "text",
       success: function(text) {
           data = d3.tsv.parseRows(text).map(function(row) {
                   return row.map(function(value) {
                       return value;
                   });
            });

            updateMFIDisplay(data);
       }
    });
}

//var displayPopulation = function() {
//    var url = "flow.pop";
//    $.ajax({
//       url: url,
//       dataType: "text",
//       success: function(data) {
//                  updatePopDisplay(data);
//                }
//    });
//}

var displayOverviewPlot = function() {
    var url = "flow.overview";
    $.ajax({
       url: url,
       dataType: "text",
       success: function(data) {
                  updateOverviewPlotDisplay(data);
                }
    });
}


var displayScatter2D = function() {
    var url = "flow.sample";
    $.ajax({
       url: url,
       dataType: "text",
       success: function(text) {
            data = d3.tsv.parseRows(text).map(function(row) {
                return row.map(function(value) {
                  if (isNaN(value)) {
                      return value;
                  }
                  return +value;
               });
            });
            
            scatterData2D['columnHeadings'] = data.shift();
            scatterData2D['columnHeadings'].pop();
            var popCol = data[0].length - 1;
            var p = data.map(function(value,index) {
                return parseInt(value[popCol]);
            });

            var populations = {};
            for (var i = 0; i < p.length; i++) {
                if (populations[p[i]] === undefined) {
                    populations[p[i]] = 1;
                } else {
                    populations[p[i]] = populations[p[i]] + 1;
                }
            }

            scatterData2D['popCol'] = popCol;
            scatterData2D['populations'] = d3.set(p).values();
            scatterData2D['populations'] = scatterData2D['populations']
                                           .map(function(value,index) {
                                             return parseInt(value);
                                           });

            scatterData2D['percent'] = scatterData2D['populations']
                                         .map(function(value,index) {
                                             return Math.floor(populations[value] * 10000.0 / data.length) / 100.0;
                                         });
    
            scatterData2D['data'] = data;
            scatterData2D['m1'] = 0;
            scatterData2D['m2'] = 1;
            updateScatterDisplay2D(scatterData2D);
       } 
    });
}
var displayScatter3D = function() {
    var url = "flow.sample";
    $.ajax({
       url: url,
       dataType: "text",
       success: function(text) {
           preprocessScatterData3D(text);
           displayScatterToolbar3D();
           displayScatterPopulation3D();
           processScatterData3D();
           displayScatterPlot3D();
           $(window).on('resize',function() {
               waitForFinalEvent(function() {
                   processScatterData3D();
                   displayScatterPlot3D();
               },500,"resize3D");
           });
       }
    });
}
var displayScatter3DMFI = function() {
    var url = "flow.mfi_pop";
    $.ajax({
       url: url,
       dataType: "text",
       success: function(text) {
           preprocessScatterData3DMFI(text);
           displayScatterToolbar3DMFI();
           displayScatterPopulation3DMFI();
           processScatterData3DMFI();
           displayScatterPlot3DMFI();
           $(window).on('resize',function() {
               waitForFinalEvent(function() {
                   processScatterData3DMFI();
                   displayScatterPlot3DMFI();
               },500,"resize3DMFI");
           });
       }
    });
}
